<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="対応履歴">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231a365d' width='100' height='100' rx='20'/><g transform='translate(26,22) scale(2)' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><rect width='8' height='4' x='8' y='2' rx='1' ry='1'/><path d='M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2'/><path d='M12 11h4'/><path d='M12 16h4'/><path d='M8 11h.01'/><path d='M8 16h.01'/></g></svg>">
<title>対面サポート CRM カルテ</title>
<style>
/* ============================================================
   対面サポート支援システム v4.0 - CRM型ユーザーカルテUI
   Target: iPad Pro 1st gen (2015) / iOS 16 Safari
   ============================================================ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --navy-900:#0c1a2e;--navy-800:#122341;--navy-700:#1a365d;
  --navy-600:#234681;--navy-500:#2c5aa0;--navy-400:#4a7cc9;
  --navy-100:#dbeafe;--navy-50:#eff6ff;
  --blue:#3b82f6;--blue-hover:#2563eb;--blue-light:rgba(59,130,246,.08);
  --bg:#f0f2f5;--bg2:#e8ebf0;--bg3:#d5dbe5;
  --card:#ffffff;--border:#d1d5db;--border-lt:#e5e7eb;
  --text:#111827;--text2:#4b5563;--text3:#6b7280;
  --green:#059669;--green-bg:#d1fae5;--green-light:#ecfdf5;
  --amber:#d97706;--amber-bg:#fef3c7;--amber-light:#fffbeb;
  --red:#dc2626;--red-bg:#fee2e2;
  --purple:#7c3aed;--purple-bg:#ede9fe;
  --r:10px;--r-lg:14px;--r-xl:18px;
  --sh:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.04);
  --sh-md:0 4px 6px rgba(0,0,0,.06),0 2px 4px rgba(0,0,0,.04);
  --sh-lg:0 10px 15px rgba(0,0,0,.08),0 4px 6px rgba(0,0,0,.04);
  --tr:.2s ease;
}
html{font-size:16px;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",system-ui,sans-serif;
  background:var(--bg);color:var(--text);line-height:1.6;
  min-height:100vh;-webkit-text-size-adjust:100%;-webkit-font-smoothing:antialiased;
}

/* ===== LOGIN ===== */
#loginScreen{
  position:fixed;inset:0;
  background:linear-gradient(155deg,var(--navy-900) 0%,var(--navy-700) 50%,var(--navy-500) 100%);
  display:flex;align-items:center;justify-content:center;z-index:9999;
}
.login-box{
  background:var(--card);border-radius:24px;box-shadow:var(--sh-lg),0 0 60px rgba(0,0,0,.15);
  padding:48px 40px;width:100%;max-width:360px;text-align:center;
}
.login-logo{
  width:68px;height:68px;
  background:linear-gradient(135deg,var(--navy-700),var(--navy-500));
  border-radius:16px;margin:0 auto 20px;
  display:flex;align-items:center;justify-content:center;
  color:#fff;box-shadow:0 4px 12px rgba(26,54,93,.3);
}
.login-logo svg{width:32px;height:32px;stroke-width:1.8}
.login-title{font-size:1.2rem;font-weight:700;color:var(--navy-700);margin-bottom:2px}
.login-sub{font-size:.85rem;color:var(--text2);margin-bottom:30px}
.dots{display:flex;justify-content:center;gap:16px;margin-bottom:28px}
.dot{width:15px;height:15px;border-radius:50%;border:2.5px solid var(--border);background:var(--card);transition:all .25s ease}
.dot.on{background:var(--navy-700);border-color:var(--navy-700);transform:scale(1.1)}
.dot.err{background:var(--red);border-color:var(--red);animation:shake .4s}
.numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;max-width:252px;margin:0 auto}
.np{
  width:72px;height:72px;border:none;border-radius:50%;background:var(--bg);
  font-size:1.5rem;font-weight:500;color:var(--navy-700);cursor:pointer;
  transition:all .15s ease;-webkit-tap-highlight-color:transparent;
  display:flex;align-items:center;justify-content:center;margin:0 auto;
  -webkit-user-select:none;user-select:none;
}
.np:active{background:var(--navy-100);transform:scale(.92)}
.np.empty{background:transparent;cursor:default}
.np.empty:active{transform:none}
.np.del{font-size:.95rem;background:transparent;color:var(--text2)}
.login-err{color:var(--red);font-size:.85rem;margin-top:16px;min-height:24px;font-weight:500}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}

/* ===== MAIN APP ===== */
#app{display:none}
.header{
  background:linear-gradient(135deg,var(--navy-800),var(--navy-600));
  color:#fff;padding:14px 20px;
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:100;
}
.header h1{font-size:1.1rem;font-weight:700;letter-spacing:.4px;display:flex;align-items:center;gap:8px}
.header h1 svg{width:20px;height:20px;stroke-width:2;flex-shrink:0}
.header-r{display:flex;align-items:center;gap:12px}
.header-count{
  font-size:.8rem;opacity:.9;font-variant-numeric:tabular-nums;
  background:rgba(255,255,255,.12);padding:4px 10px;border-radius:6px;
}
.h-btn{
  padding:8px 14px;border:1px solid rgba(255,255,255,.35);border-radius:8px;
  background:rgba(255,255,255,.1);color:#fff;font-size:.75rem;cursor:pointer;
  font-weight:500;transition:all var(--tr);min-height:44px;
  display:inline-flex;align-items:center;
}
.h-btn:active{background:rgba(255,255,255,.25)}

/* ===== TABS ===== */
.tabs{
  display:flex;background:var(--card);border-bottom:1px solid var(--border-lt);
  position:sticky;top:50px;z-index:99;
}
.tab{
  flex:1;padding:10px 6px 8px;border:none;background:none;
  font-size:.75rem;font-weight:500;color:var(--text3);cursor:pointer;
  border-bottom:3px solid transparent;transition:all var(--tr);
  -webkit-tap-highlight-color:transparent;
  display:flex;flex-direction:column;align-items:center;gap:4px;
}
.tab .ico{display:flex;align-items:center;justify-content:center;width:28px;height:28px}
.tab .ico svg{width:24px;height:24px;stroke-width:1.8}
.tab.on{color:var(--blue);border-bottom-color:var(--blue);font-weight:700}
.tab.on .ico svg{stroke-width:2.2}

/* ===== PANELS ===== */
.pnl{display:none;padding:20px 16px 100px;max-width:960px;margin:0 auto}
.pnl.on{display:block}

/* ===== CARDS ===== */
.card{
  background:var(--card);border-radius:var(--r-lg);
  box-shadow:var(--sh);padding:20px;margin-bottom:16px;
}
.card-t{
  font-size:.95rem;font-weight:700;color:var(--navy-700);
  margin-bottom:14px;display:flex;align-items:center;gap:8px;
}
.card-t .ct-ico{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;flex-shrink:0}
.card-t .ct-ico svg{width:20px;height:20px;stroke-width:2}

/* ===== STATS ===== */
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
.st{
  background:var(--card);border-radius:var(--r-lg);box-shadow:var(--sh);
  padding:18px 16px;position:relative;overflow:hidden;
  transition:transform var(--tr);cursor:pointer;
}
.st:active{transform:scale(.98)}
.st::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;border-radius:0 2px 2px 0}
.st:nth-child(1)::before{background:var(--blue)}
.st:nth-child(2)::before{background:var(--green)}
.st:nth-child(3)::before{background:var(--amber)}
.st:nth-child(4)::before{background:var(--purple)}
.st-v{font-size:1.8rem;font-weight:800;color:var(--navy-800);line-height:1.1;font-variant-numeric:tabular-nums}
.st-l{font-size:.75rem;color:var(--text2);margin-top:4px;font-weight:500}

/* ===== SEARCH INPUT ===== */
.sbox{display:flex;gap:10px}
.sinput{
  flex:1;padding:14px 16px;border:2px solid var(--border-lt);border-radius:var(--r);
  font-size:1.05rem;outline:none;transition:border var(--tr),box-shadow var(--tr);
  -webkit-appearance:none;background:var(--bg);min-height:52px;
}
.sinput:focus{border-color:var(--blue);box-shadow:0 0 0 4px rgba(59,130,246,.1);background:var(--card)}
.sinput::placeholder{color:var(--text3)}
.sinput-lg{font-size:1.3rem;padding:18px 20px;min-height:64px;text-align:center;letter-spacing:1px}

/* ===== BUTTONS ===== */
.btn{
  padding:14px 22px;border:none;border-radius:var(--r);
  font-size:.9rem;font-weight:600;cursor:pointer;
  min-height:52px;transition:all var(--tr);
  -webkit-tap-highlight-color:transparent;
  display:inline-flex;align-items:center;justify-content:center;gap:6px;
  -webkit-user-select:none;user-select:none;
}
.btn:active{transform:scale(.97)}
.btn-p{background:var(--blue);color:#fff}
.btn-p:active{background:var(--blue-hover)}
.btn-s{background:var(--bg2);color:var(--text)}
.btn-g{background:transparent;color:var(--blue);border:1.5px solid var(--border)}
.btn-d{background:var(--red);color:#fff}
.btn-ok{background:var(--green);color:#fff}
.btn-sm{padding:10px 16px;font-size:.82rem;min-height:40px}
.btn-bl{width:100%;display:flex}

/* ===== SUB TABS ===== */
.stabs{display:flex;gap:4px;margin-bottom:18px;background:var(--bg2);padding:4px;border-radius:var(--r)}
.stab{
  flex:1;padding:11px 8px;border:none;border-radius:8px;background:transparent;
  font-size:.85rem;font-weight:500;color:var(--text2);cursor:pointer;text-align:center;
  transition:all var(--tr);-webkit-tap-highlight-color:transparent;min-height:44px;
}
.stab.on{background:var(--card);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,.06);font-weight:700}

/* ===== FILTERS ===== */
.frow{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.fsel{
  padding:11px 12px;border:1.5px solid var(--border-lt);border-radius:8px;
  font-size:.85rem;background:var(--bg);-webkit-appearance:none;
  min-width:120px;min-height:44px;color:var(--text);
}

/* ===== RESULT CARDS ===== */
.rc{
  background:var(--card);border-radius:var(--r-lg);
  box-shadow:var(--sh);margin-bottom:12px;overflow:hidden;
  border:1.5px solid var(--border-lt);transition:border-color var(--tr);
}
.rc.exp{border-color:var(--blue)}
.rc-h{padding:16px 18px;cursor:pointer;-webkit-tap-highlight-color:transparent}
.rc-h:active{background:var(--bg)}
.rc-meta{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-bottom:6px}
.rc-sum{font-size:.88rem;color:var(--text2);line-height:1.5}
.rc-b{display:none;padding:0 18px 18px;border-top:1px solid var(--border-lt)}
.rc.exp .rc-b{display:block;padding-top:16px}
.rc-arrow{float:right;color:var(--text3);font-size:.75rem;transition:transform var(--tr);margin-top:2px}
.rc.exp .rc-arrow{transform:rotate(90deg);color:var(--blue)}

/* ===== TAGS ===== */
.tg{
  display:inline-flex;align-items:center;
  padding:3px 10px;border-radius:6px;
  font-size:.72rem;font-weight:600;letter-spacing:.15px;white-space:nowrap;
}
.tg-dt{background:var(--navy-50);color:var(--navy-600)}
.tg-id{background:var(--bg2);color:var(--navy-700);font-family:"SF Mono",Menlo,monospace;font-size:.72rem}
.tg-dv{background:var(--green-light);color:#047857}
.tg-ct{background:var(--amber-bg);color:#92400e}
.tg-st{background:#fce7f3;color:#9d174d}
.tg-esc{background:var(--red-bg);color:var(--red);font-weight:700}
.tg-media{background:var(--purple-bg);color:var(--purple)}
.tg-rep{background:#dbeafe;color:#1e40af;font-weight:700}
.tg svg{display:inline-block;vertical-align:-2px;width:14px;height:14px;flex-shrink:0;margin-right:2px}

/* Detail rows */
.dl{margin-top:14px}
.dl-l{font-size:.72rem;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.6px;margin-bottom:4px}
.dl-v{font-size:.9rem;line-height:1.7;white-space:pre-wrap;color:var(--text)}

/* Result info bar */
.rinfo{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:14px;padding:12px 16px;
  background:var(--navy-50);border-radius:var(--r);font-size:.88rem;
}
.rinfo b{color:var(--navy-700)}

/* ===== RECENT / TOP ===== */
.rec{
  padding:16px 0;border-bottom:1px solid var(--border-lt);
  cursor:pointer;-webkit-tap-highlight-color:transparent;transition:opacity var(--tr);
}
.rec:last-child{border-bottom:none}
.rec:active{opacity:.6}
.top-li{list-style:none}
.top-li li{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 0;border-bottom:1px solid var(--border-lt);font-size:.9rem;
  cursor:pointer;-webkit-tap-highlight-color:transparent;
}
.top-li li:last-child{border-bottom:none}
.top-li li:active{opacity:.6}
.top-n{font-weight:700;color:var(--blue);font-size:1.05rem;min-width:40px;text-align:right}

/* Quick grid */
.qgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px}
.qbtn{
  padding:16px 10px;border:1.5px solid var(--border-lt);border-radius:var(--r);
  background:var(--card);font-size:.82rem;font-weight:500;cursor:pointer;
  text-align:center;transition:all var(--tr);-webkit-tap-highlight-color:transparent;
  line-height:1.4;min-height:52px;
}
.qbtn:active{background:var(--navy-50);border-color:var(--blue)}
.qbtn b{display:block;font-weight:700;color:var(--blue);font-size:1rem;margin-top:4px}

/* ===== REMINDER / BANNERS ===== */
.reminder{
  background:linear-gradient(135deg,var(--amber-light),#fff7ed);
  border:1.5px solid #fbbf24;border-radius:var(--r-lg);
  padding:16px 18px;margin-bottom:18px;
  display:flex;align-items:flex-start;gap:14px;
  font-size:.88rem;color:#78350f;line-height:1.6;
}
.reminder-ico{flex-shrink:0;margin-top:2px;display:flex;align-items:center;width:24px;height:24px}
.reminder-ico svg{width:24px;height:24px;stroke:var(--amber)}
.rep-banner{
  background:linear-gradient(135deg,#eff6ff,#dbeafe);
  border:1.5px solid var(--blue);border-radius:var(--r-lg);
  padding:16px 18px;margin-bottom:14px;
  font-size:.9rem;color:var(--navy-700);line-height:1.6;
}
.rep-banner b{font-size:1.1rem}

/* ===== SIMILAR CASES ===== */
.sim-cases{
  background:linear-gradient(135deg,#f0fdf4,#ecfdf5);
  border:1.5px solid #86efac;border-radius:var(--r-lg);
  padding:16px 18px;margin-top:18px;
}
.sim-cases-t{font-size:.92rem;font-weight:700;color:#065f46;margin-bottom:12px;display:flex;align-items:center;gap:6px}
.sim-case{
  background:#fff;border:1px solid #d1fae5;border-radius:var(--r);
  padding:12px 14px;margin-bottom:8px;cursor:pointer;
  transition:all var(--tr);-webkit-tap-highlight-color:transparent;
}
.sim-case:last-child{margin-bottom:0}
.sim-case:active{background:#ecfdf5;border-color:#6ee7b7}
.sim-case-header{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-bottom:6px}
.sim-case-header .tg{font-size:.68rem;padding:2px 8px}
.sim-case-text{font-size:.82rem;color:var(--text2);line-height:1.5}
.sim-case-response{font-size:.82rem;color:var(--text);line-height:1.5;margin-top:6px;padding-top:6px;border-top:1px dashed #d1fae5}
.sim-case-response b{color:#065f46;font-weight:600;font-size:.75rem}

/* ===== KARTE ===== */
.karte-search-wrap{
  display:flex;flex-direction:column;align-items:center;
  padding:40px 20px 20px;
}
.karte-search-wrap .sinput-lg{max-width:480px;width:100%}
.karte-search-hint{font-size:.85rem;color:var(--text3);margin-top:10px;text-align:center}

/* Highlight Panel */
.k-highlight{
  background:linear-gradient(135deg,var(--navy-800),var(--navy-600));
  color:#fff;border-radius:var(--r-xl);padding:22px 24px;margin-bottom:20px;
  position:sticky;top:96px;z-index:50;box-shadow:var(--sh-lg);
}
.k-hl-id{font-size:1.3rem;font-weight:800;letter-spacing:1px;font-family:"SF Mono",Menlo,monospace}
.k-hl-meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;align-items:center;font-size:.88rem;opacity:.92}
.k-hl-meta span{display:inline-flex;align-items:center;gap:4px}
.k-hl-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
.k-hl-tag{
  display:inline-flex;align-items:center;padding:4px 12px;border-radius:20px;
  font-size:.78rem;font-weight:600;background:rgba(255,255,255,.18);color:#fff;
}
.k-hl-tag.esc{background:rgba(220,38,38,.7)}
.k-back{
  display:inline-flex;align-items:center;gap:4px;
  color:var(--blue);font-size:.88rem;font-weight:600;cursor:pointer;
  padding:8px 12px;margin-bottom:12px;border:none;background:var(--card);
  -webkit-tap-highlight-color:transparent;min-height:44px;
  position:sticky;top:96px;z-index:51;border-radius:var(--r);box-shadow:var(--sh);
}
.k-back:active{opacity:.6}

/* Previous visit card */
.k-prev{
  background:linear-gradient(135deg,#eff6ff,#dbeafe);
  border:2px solid var(--blue);border-radius:var(--r-lg);
  padding:20px;margin-bottom:20px;
}
.k-prev-t{font-size:.78rem;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
.k-prev-cat{font-size:1.05rem;font-weight:700;color:var(--navy-700);margin-bottom:4px}
.k-prev-staff{font-size:.85rem;color:var(--text2);margin-bottom:8px}
.k-prev-body{font-size:.9rem;line-height:1.7;color:var(--text)}

/* Stats grid inside karte */
.k-stats{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.k-stat-card{background:var(--card);border-radius:var(--r-lg);box-shadow:var(--sh);padding:18px}
.k-stat-card h4{font-size:.78rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px}
.k-stat-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;font-size:.88rem}
.k-stat-row+.k-stat-row{border-top:1px solid var(--border-lt)}
.k-stat-val{font-weight:700;color:var(--navy-700)}
.k-cat-bar{height:6px;background:var(--bg2);border-radius:3px;flex:1;margin:0 10px;overflow:hidden}
.k-cat-fill{height:100%;background:var(--blue);border-radius:3px}

/* Timeline */
.tl{position:relative;padding-left:28px}
.tl::before{content:'';position:absolute;left:8px;top:0;bottom:0;width:2px;background:var(--border)}
.tl-item{position:relative;margin-bottom:20px}
.tl-dot{
  position:absolute;left:-24px;top:4px;width:12px;height:12px;
  border-radius:50%;background:var(--blue);border:2px solid var(--card);
  z-index:1;
}
.tl-dot.esc{background:var(--red)}
.tl-head{
  display:flex;flex-wrap:wrap;gap:6px;align-items:center;
  cursor:pointer;-webkit-tap-highlight-color:transparent;min-height:44px;
}
.tl-head:active{opacity:.7}
.tl-date{font-size:.82rem;font-weight:700;color:var(--navy-700)}
.tl-body{
  display:none;margin-top:10px;padding:14px;
  background:var(--bg);border-radius:var(--r);font-size:.88rem;line-height:1.7;
}
.tl-item.open .tl-body{display:block}
.tl-arrow{font-size:.7rem;color:var(--text3);transition:transform var(--tr)}
.tl-item.open .tl-arrow{transform:rotate(90deg);color:var(--blue)}

/* Repeater list */
.rep-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:14px 0;border-bottom:1px solid var(--border-lt);
  cursor:pointer;-webkit-tap-highlight-color:transparent;min-height:52px;
}
.rep-item:last-child{border-bottom:none}
.rep-item:active{opacity:.6}
.rep-id{font-family:"SF Mono",Menlo,monospace;font-weight:600;color:var(--navy-700);font-size:.9rem}
.rep-info{font-size:.8rem;color:var(--text2);margin-top:2px}
.rep-count{
  background:var(--blue);color:#fff;font-weight:700;font-size:.82rem;
  padding:4px 12px;border-radius:20px;white-space:nowrap;
}

/* ===== SETTINGS ===== */
.scard{background:var(--card);border-radius:var(--r-lg);box-shadow:var(--sh);padding:24px;margin-bottom:16px}
.scard-t{font-size:.95rem;font-weight:700;color:var(--navy-700);margin-bottom:6px}
.scard-d{font-size:.85rem;color:var(--text2);margin-bottom:16px;line-height:1.6}
.scard-m{font-size:.85rem;color:var(--text2);margin-top:12px}
.sbar{height:8px;background:var(--bg2);border-radius:4px;overflow:hidden;margin-top:8px}
.sbar-f{height:100%;background:var(--blue);border-radius:4px;transition:width .3s}
.pwa-notice{
  background:var(--navy-50);border:1.5px solid var(--navy-100);
  border-radius:var(--r-lg);padding:16px 18px;margin-bottom:16px;
  font-size:.85rem;color:var(--navy-700);line-height:1.6;
}
.pwa-notice b{display:block;margin-bottom:4px;font-size:.9rem}
.pwa-banner{
  background:linear-gradient(135deg,#eff6ff,#dbeafe);
  border:1.5px solid var(--blue);border-radius:var(--r-lg);
  padding:16px 18px;margin-bottom:18px;
  display:flex;align-items:flex-start;gap:14px;
  font-size:.85rem;color:var(--navy-700);line-height:1.6;
}
.pwa-banner-ico{flex-shrink:0;margin-top:2px;display:flex;align-items:center;width:24px;height:24px}
.pwa-banner-ico svg{width:24px;height:24px}
.pwa-banner-x{
  border:none;background:none;color:var(--text3);font-size:1.2rem;
  cursor:pointer;padding:4px;margin-left:auto;flex-shrink:0;
  min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center;
}

/* ===== MODAL ===== */
.mo{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:200;
  overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px;
}
.mo.on{display:flex;justify-content:center;align-items:flex-start}
.mo-c{
  background:var(--card);border-radius:var(--r-xl);
  width:100%;max-width:640px;margin:20px auto;
  overflow:hidden;box-shadow:var(--sh-lg);
}
.mo-top{
  background:linear-gradient(135deg,var(--navy-800),var(--navy-600));
  color:#fff;padding:18px 22px;
  display:flex;justify-content:space-between;align-items:center;
}
.mo-top h2{font-size:1rem;font-weight:700}
.mo-x{
  width:44px;height:44px;border:none;background:rgba(255,255,255,.15);
  color:#fff;border-radius:50%;font-size:1.3rem;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:background var(--tr);
}
.mo-x:active{background:rgba(255,255,255,.3)}
.mo-bd{padding:22px}
.mo-sec{margin-bottom:20px}
.mo-sec:last-child{margin-bottom:0}
.mo-sec-t{
  font-size:.72rem;color:var(--text3);font-weight:700;
  text-transform:uppercase;letter-spacing:.7px;margin-bottom:10px;
  padding-bottom:6px;border-bottom:1px solid var(--border-lt);
}
.mo-f{margin-bottom:14px}
.mo-f:last-child{margin-bottom:0}
.mo-fl{font-size:.7rem;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.6px;margin-bottom:3px}
.mo-fv{font-size:.92rem;line-height:1.7;white-space:pre-wrap}

/* ===== TOAST ===== */
.toast{
  position:fixed;bottom:90px;left:50%;transform:translateX(-50%);
  padding:14px 28px;border-radius:var(--r);box-shadow:var(--sh-lg);
  font-size:.88rem;font-weight:500;z-index:300;
  display:none;max-width:90%;text-align:center;color:#fff;
}
.toast.i{background:var(--navy-700)}
.toast.ok{background:var(--green)}
.toast.er{background:var(--red)}
.toast.v{display:block;animation:tin .3s ease}
@keyframes tin{from{opacity:0;transform:translate(-50%,14px)}to{opacity:1;transform:translate(-50%,0)}}

/* ===== EMPTY ===== */
.empty-state{text-align:center;padding:50px 24px}
.empty-i{margin-bottom:12px;opacity:.5;display:flex;align-items:center;justify-content:center}
.empty-i svg{width:48px;height:48px;stroke-width:1.5}
.empty-t{font-size:.92rem;color:var(--text2);line-height:1.7}

/* ===== WEEKLY SUMMARY ===== */
.wk-stat{display:flex;flex-wrap:wrap;gap:12px;padding:12px 0;font-size:.85rem;border-bottom:1px solid var(--border-lt)}
.wk-stat-item{display:flex;align-items:center;gap:4px}
.wk-stat-n{font-weight:700;color:var(--navy-700)}
.wk-rec-date{font-weight:700;color:var(--navy-700);margin-right:6px}
.wk-rec-cat{display:inline-block;background:var(--navy-50);color:var(--navy-700);padding:1px 8px;border-radius:10px;font-size:.75rem;font-weight:600;margin-right:4px}
.wk-rec-body{color:var(--text2);margin-top:2px;font-size:.82rem}
.wk-none{font-size:.85rem;color:var(--text3);padding:12px 0}
.wk-acc{border-bottom:1px solid var(--border-lt)}
.wk-acc:last-child{border-bottom:none}
.wk-acc-hd{display:flex;align-items:flex-start;gap:8px;padding:12px 0;cursor:pointer;-webkit-tap-highlight-color:transparent;min-height:48px;font-size:.85rem;line-height:1.6}
.wk-acc-hd:active{opacity:.6}
.wk-acc-arrow{font-size:.65rem;color:var(--text3);transition:transform var(--tr);margin-top:4px;flex-shrink:0}
.wk-acc.open .wk-acc-arrow{transform:rotate(90deg);color:var(--blue)}
.wk-acc-body{display:none;padding:0 0 14px 0}
.wk-acc.open .wk-acc-body{display:block}
.wk-acc-sec{margin-bottom:10px}
.wk-acc-label{font-size:.72rem;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.wk-acc-val{font-size:.88rem;line-height:1.7;white-space:pre-wrap;color:var(--text)}
.wk-details-hd{display:flex;justify-content:space-between;align-items:center;padding:12px 0;cursor:pointer;-webkit-tap-highlight-color:transparent;min-height:44px;border-top:1px solid var(--border-lt)}
.wk-details-hd:active{opacity:.6}
.wk-details-arrow{font-size:.65rem;color:var(--text3);transition:transform var(--tr)}
.wk-details.open .wk-details-arrow{transform:rotate(90deg);color:var(--blue)}
.wk-details-body{display:none}
.wk-details.open .wk-details-body{display:block}

/* ===== RESPONSIVE ===== */
@media(min-width:768px){
  .stats{grid-template-columns:repeat(4,1fr)}
  .pnl{padding:24px 20px 100px}
  .r2c{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .qgrid{grid-template-columns:repeat(4,1fr)}
  .k-stats{grid-template-columns:1fr 1fr}
}
@media(max-width:767px){
  .tab{font-size:.68rem;padding:8px 3px 6px}.tab .ico svg{width:22px;height:22px}
  .login-box{padding:36px 24px}.np{width:64px;height:64px;font-size:1.3rem}
  .k-stats{grid-template-columns:1fr}
  .k-highlight{position:static}
}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
/* ===== STATS CHARTS ===== */
.chart-card{background:var(--card);border-radius:var(--r-lg);box-shadow:var(--sh);padding:20px;margin-bottom:16px}
.chart-card-t{font-size:.95rem;font-weight:700;color:var(--navy-700);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.chart-card-t .ct-ico{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;flex-shrink:0}
.chart-card-t .ct-ico svg{width:20px;height:20px;stroke-width:2}

/* KPI Grid - large readable numbers with accent bar */
.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.kpi{background:var(--card);border-radius:var(--r-lg);box-shadow:var(--sh);padding:18px 16px;text-align:center;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;border-radius:14px 14px 0 0}
.kpi:nth-child(1)::before{background:var(--blue)}
.kpi:nth-child(2)::before{background:var(--green)}
.kpi:nth-child(3)::before{background:var(--purple)}
.kpi:nth-child(4)::before{background:var(--red)}
.kpi:nth-child(5)::before{background:var(--amber)}
.kpi:nth-child(6)::before{background:var(--navy-500)}
.kpi-v{font-size:2rem;font-weight:800;color:var(--navy-800);font-variant-numeric:tabular-nums;line-height:1.1}
.kpi-l{font-size:.78rem;color:var(--text2);margin-top:6px;font-weight:600}
.kpi-sub{font-size:.72rem;color:var(--text3);margin-top:3px;font-weight:500}

/* Vertical bar chart */
.vbar-wrap{display:flex;align-items:flex-end;gap:6px;height:200px;padding:0 4px;border-bottom:2px solid var(--border-lt)}
.vbar{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;position:relative;min-width:0;height:100%}
.vbar-fill{width:100%;max-width:50px;border-radius:5px 5px 0 0;background:var(--blue);transition:height .3s ease;min-height:2px;flex-shrink:0}
.vbar-val{font-size:.72rem;font-weight:700;color:var(--navy-700);margin-bottom:3px;font-variant-numeric:tabular-nums}
.vbar-labels{display:flex;gap:6px;padding:8px 4px 0;justify-content:space-around}
.vbar-lbl{flex:1;text-align:center;font-size:.68rem;color:var(--text3);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.3}
.vbar-lbl-year{display:block;font-size:.58rem;color:var(--text3);font-weight:400;opacity:.7}

/* Horizontal bar chart */
.hbar{display:flex;align-items:center;gap:8px;margin-bottom:10px;border-radius:6px;padding:2px 0;transition:background var(--tr)}
.hbar:last-child{margin-bottom:0}
.hbar-clickable{cursor:pointer;-webkit-tap-highlight-color:transparent}
.hbar-clickable:active{background:var(--blue-light)}
.hbar-label{font-size:.82rem;color:var(--text);min-width:110px;max-width:160px;overflow:hidden;text-overflow:ellipsis;flex-shrink:0;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;white-space:normal;word-break:break-all}
.hbar-track{flex:1;height:26px;background:var(--bg2);border-radius:5px;overflow:hidden;position:relative}
.hbar-fill{height:100%;border-radius:5px;transition:width .3s ease}
.hbar-num{font-size:.82rem;font-weight:700;color:var(--navy-700);min-width:48px;text-align:right;font-variant-numeric:tabular-nums;flex-shrink:0}

/* Heatmap */
.heatmap{display:grid;grid-template-columns:auto repeat(7,1fr);gap:4px;font-size:.75rem}
.hm-header{font-weight:700;color:var(--text3);text-align:center;padding:6px 2px}
.hm-label{font-size:.75rem;color:var(--text3);text-align:right;padding:6px 8px 6px 0;white-space:nowrap;font-weight:500}
.hm-cell{border-radius:4px;text-align:center;padding:8px 2px;font-size:.75rem;font-weight:600;font-variant-numeric:tabular-nums;min-height:36px;display:flex;align-items:center;justify-content:center}

/* Ratio bar (donut-like) */
.ratio-bar{display:flex;height:32px;border-radius:6px;overflow:hidden;margin-bottom:8px}
.ratio-seg{display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:700;color:#fff;transition:width .3s ease;min-width:0;overflow:hidden}
.ratio-legend{display:flex;gap:16px;flex-wrap:wrap;margin-top:6px}
.ratio-legend-item{display:flex;align-items:center;gap:6px;font-size:.82rem;color:var(--text)}
.ratio-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}

/* Sparkline / mini line chart */
.spark-wrap{position:relative;height:100px;margin-top:8px}
.spark-svg{width:100%;height:100%}
.spark-line{fill:none;stroke:var(--red);stroke-width:3;stroke-linecap:round;stroke-linejoin:round}
.spark-area{fill:url(#sparkGrad)}
.spark-dot{fill:var(--red);stroke:#fff;stroke-width:2.5}
.spark-grid-line{stroke:var(--border-lt);stroke-width:0.5;stroke-dasharray:6 4}
.spark-label{font-size:.65rem;fill:var(--text3);font-weight:500}
.spark-val-label{font-size:11px;fill:var(--navy-700);font-weight:700}

/* Period selector - 2 rows for clean layout */
.stats-period{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:18px;background:var(--bg2);padding:5px;border-radius:var(--r)}
.stats-period-btn{
  padding:11px 10px;border:none;border-radius:8px;background:transparent;
  font-size:.85rem;font-weight:500;color:var(--text2);cursor:pointer;text-align:center;
  transition:all var(--tr);min-height:44px;-webkit-tap-highlight-color:transparent;
  flex:1 1 auto;min-width:0;
}
.stats-period-btn.on{background:var(--card);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,.08);font-weight:700}

/* Stats period label */
.stats-period-label{
  font-size:.92rem;color:var(--text2);margin-bottom:18px;font-weight:500;
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
}
.stats-period-count{color:var(--navy-700);font-size:1.2rem;font-weight:800;font-variant-numeric:tabular-nums}

@media(max-width:767px){
  .kpi-grid{grid-template-columns:repeat(2,1fr)}
  .kpi-v{font-size:1.7rem}
  .hbar-label{min-width:80px;max-width:120px;font-size:.78rem}
  .vbar-wrap{height:180px}
  .vbar-lbl{font-size:.6rem}
  .heatmap{gap:3px;font-size:.7rem}
  .hm-cell{padding:6px 2px;min-height:30px;font-size:.7rem}
  .stats-period-btn{font-size:.78rem;padding:10px 6px}
}
@media(min-width:768px){
  .hbar-label{min-width:130px;max-width:180px}
}

@media(prefers-reduced-motion:reduce){
  *,*::before,*::after{animation-duration:0.01ms!important;animation-iteration-count:1!important;transition-duration:0.01ms!important;scroll-behavior:auto!important}
  .dot.err{animation:none}
}
</style>
</head>
<body>

<!-- ===== LOGIN ===== -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo" data-icon="shield-check" data-icon-size="32"></div>
    <div class="login-title">対面サポート支援システム</div>
    <div class="login-sub">パスコードを入力してください</div>
    <div class="dots" id="dots">
      <div class="dot" id="d0"></div><div class="dot" id="d1"></div>
      <div class="dot" id="d2"></div><div class="dot" id="d3"></div>
      <div class="dot" id="d4"></div><div class="dot" id="d5"></div>
    </div>
    <div class="numpad">
      <button class="np" onclick="nd('1')">1</button>
      <button class="np" onclick="nd('2')">2</button>
      <button class="np" onclick="nd('3')">3</button>
      <button class="np" onclick="nd('4')">4</button>
      <button class="np" onclick="nd('5')">5</button>
      <button class="np" onclick="nd('6')">6</button>
      <button class="np" onclick="nd('7')">7</button>
      <button class="np" onclick="nd('8')">8</button>
      <button class="np" onclick="nd('9')">9</button>
      <button class="np empty"></button>
      <button class="np" onclick="nd('0')">0</button>
      <button class="np del" onclick="ndel()">&#9003;</button>
    </div>
    <div class="login-err" id="lerr"></div>
  </div>
</div>

<!-- ===== APP ===== -->
<div id="app">
  <div class="header">
    <h1><span data-icon="clipboard-list" data-icon-size="20"></span>対面サポート支援</h1>
    <div class="header-r">
      <span class="header-count" id="hCount">0件</span>
      <span class="header-count" id="syncStatus" style="font-size:.7rem;opacity:.8">---</span>
      <button class="h-btn" onclick="logout()">ログアウト</button>
    </div>
  </div>

  <div class="tabs" role="tablist">
    <button class="tab on" onclick="go('home')" role="tab" aria-selected="true" aria-controls="p-home"><span class="ico" data-icon="home"></span>ホーム</button>
    <button class="tab" onclick="go('karte')" role="tab" aria-selected="false" aria-controls="p-karte"><span class="ico" data-icon="user"></span>カルテ</button>
    <button class="tab" onclick="go('search')" role="tab" aria-selected="false" aria-controls="p-search"><span class="ico" data-icon="search"></span>検索</button>
    <button class="tab" onclick="go('stats')" role="tab" aria-selected="false" aria-controls="p-stats"><span class="ico" data-icon="bar-chart-3"></span>統計</button>
    <button class="tab" onclick="go('settings')" role="tab" aria-selected="false" aria-controls="p-settings"><span class="ico" data-icon="settings"></span>設定</button>
  </div>

  <!-- ===== HOME ===== -->
  <div class="pnl on" id="p-home">
    <div id="nodata" class="empty-state">
      <div class="empty-i" data-icon="clipboard-list" data-icon-size="48"></div>
      <p class="empty-t">データがまだありません<br>設定タブからCSVをインポートしてください</p>
      <button class="btn btn-p" style="margin-top:16px" onclick="go('settings')">CSVインポートへ</button>
    </div>
    <div id="hasdata" style="display:none">
      <div class="pwa-banner" id="pwaBanner" style="display:none">
        <span class="pwa-banner-ico" data-icon="download"></span>
        <div>
          <b>ホーム画面に追加してください</b><br>
          Safari下部の <b>共有ボタン（□↑）</b>→「<b>ホーム画面に追加</b>」で、アプリとして使えます。<br>
          <span style="color:var(--red);font-weight:600">追加しないと7日後にデータが消える場合があります</span>
        </div>
        <button class="pwa-banner-x" onclick="dismissPwaBanner()" aria-label="閉じる">×</button>
      </div>
      <div class="reminder">
        <span class="reminder-ico" data-icon="camera"></span>
        <div>
          <b>トラブル対応時のリマインド</b><br>
          問題が発生したら<b>スクリーンショット</b>または<b>動画撮影</b>を忘れずに！<br>
          後からの原因調査・開発チームへの共有に必須です。
        </div>
      </div>

      <!-- Quick ID Search -->
      <div class="card">
        <div class="card-t"><span class="ct-ico" data-icon="search" data-icon-size="20"></span>ユーザーID クイック検索</div>
        <div class="sbox">
          <input class="sinput" id="qi" placeholder="ユーザーID（例: 582619058）" inputmode="tel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" aria-label="ユーザーID クイック検索">
          <button class="btn btn-p" onclick="quickSearch()">検索</button>
        </div>
        <div id="qr" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <div class="card-t"><span class="ct-ico" data-icon="calendar" data-icon-size="20"></span>週ごとの対応サマリー</div>
        <select class="fsel" id="weekSelect" onchange="renderWeeklySummary()" style="margin-bottom:12px"></select>
        <div id="weeklySummary"></div>
      </div>

      <div class="stats" id="stats"></div>

      <div class="card">
        <div class="card-t"><span class="ct-ico" data-icon="bar-chart-3" data-icon-size="20"></span>よくある相談カテゴリ</div>
        <div class="qgrid" id="qgrid"></div>
      </div>
      <div class="card">
        <div class="card-t"><span class="ct-ico" data-icon="clock" data-icon-size="20"></span>最近の対応（直近5件）</div>
        <div id="recent"></div>
      </div>
    </div>
  </div>

  <!-- ===== KARTE ===== -->
  <div class="pnl" id="p-karte">
    <div id="karteInit">
      <div class="karte-search-wrap">
        <div style="margin-bottom:8px;color:var(--text3)" data-icon="user" data-icon-size="40"></div>
        <div style="font-size:1.1rem;font-weight:700;color:var(--navy-700);margin-bottom:16px">ユーザーカルテ</div>
        <input class="sinput sinput-lg" id="karteId" placeholder="ユーザーIDを入力" inputmode="tel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" aria-label="カルテ用ユーザーID">
        <button class="btn btn-p btn-bl" style="margin-top:12px;max-width:480px" onclick="var v=document.getElementById('karteId').value.trim();if(v)showKarte(v);">カルテを表示</button>
        <div class="karte-search-hint">IDを入力して「カルテを表示」ボタンを押してください</div>
      </div>
      <div id="karteRecent" style="margin-top:20px"></div>
      <div id="karteRepeaters" style="margin-top:20px"></div>
    </div>
    <div id="karteView" style="display:none"></div>
  </div>

  <!-- ===== SEARCH ===== -->
  <div class="pnl" id="p-search">
    <div class="stabs" id="searchStabs">
      <button class="stab on" onclick="setSearchMode('uid')">ユーザーID</button>
      <button class="stab" onclick="setSearchMode('dev')">機種別</button>
      <button class="stab" onclick="setSearchMode('kw')">フリーワード</button>
    </div>
    <div class="card" style="padding:18px">
      <div id="m-uid">
        <div class="sbox">
          <input class="sinput" id="si-uid" placeholder="ユーザーID（ハイフン不要）" inputmode="tel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" aria-label="ユーザーID検索">
          <button class="btn btn-p" onclick="doSearch()">検索</button>
        </div>
      </div>
      <div id="m-dev" style="display:none">
        <div class="sbox">
          <input class="sinput" id="si-dev" placeholder="機種名（例: AQUOS, Pixel, Galaxy）" autocomplete="off">
          <button class="btn btn-p" onclick="doSearch()">検索</button>
        </div>
        <div id="devSummary" style="margin-top:12px"></div>
      </div>
      <div id="m-kw" style="display:none">
        <div class="sbox">
          <input class="sinput" id="si-kw" placeholder="キーワード（例: 歩数 カウント）" autocomplete="off">
          <button class="btn btn-p" onclick="doSearch()">検索</button>
        </div>
        <div class="frow">
          <select class="fsel" id="fc"><option value="">カテゴリ：全て</option></select>
          <select class="fsel" id="fs"><option value="">担当：全て</option></select>
          <select class="fsel" id="fp">
            <option value="">期間：全て</option>
            <option value="week">今週</option>
            <option value="1">今月</option>
            <option value="last">先月</option>
            <option value="3">過去3ヶ月</option>
            <option value="6">過去6ヶ月</option>
            <option value="year">今年</option>
            <option value="custom">日付を指定</option>
          </select>
          <select class="fsel" id="fe">
            <option value="">エスカレ：全て</option>
            <option value="yes">エスカレあり</option>
            <option value="no">エスカレなし</option>
          </select>
        </div>
        <div class="frow" id="dateRange" style="display:none;align-items:center">
          <label style="font-size:.82rem;color:var(--text2);font-weight:600;white-space:nowrap">開始日</label>
          <input type="date" class="sinput" id="si-from" style="flex:1;min-height:44px">
          <label style="font-size:.82rem;color:var(--text2);font-weight:600;white-space:nowrap">〜 終了日</label>
          <input type="date" class="sinput" id="si-to" style="flex:1;min-height:44px">
        </div>
      </div>
    </div>
    <div id="ri" style="display:none" class="rinfo">
      <span><b id="rn">0</b>件の結果</span>
      <button class="btn btn-sm btn-g" onclick="clearResults()">クリア</button>
    </div>
    <div id="sr" aria-live="polite"></div>
    <div id="se" class="empty-state"><div class="empty-i" data-icon="search" data-icon-size="48"></div><p class="empty-t">上の検索欄に条件を入力して検索してください</p></div>
    <div id="smore" style="display:none;text-align:center;margin-top:14px">
      <button class="btn btn-g" onclick="showMore()">もっと見る</button>
    </div>
  </div>

  <!-- ===== STATS ===== -->
  <div class="pnl" id="p-stats">
    <div style="font-size:1.1rem;font-weight:700;color:var(--navy-700);margin-bottom:18px">統計ダッシュボード</div>
    <div id="statsContent">
      <div class="empty-state"><div class="empty-i" data-icon="bar-chart-3" data-icon-size="48"></div><p class="empty-t">データを読み込み中...</p></div>
    </div>
  </div>

  <!-- ===== SETTINGS ===== -->
  <div class="pnl" id="p-settings">
    <div style="font-size:1.1rem;font-weight:700;color:var(--navy-700);margin-bottom:18px">データ管理</div>
    <div class="pwa-notice">
      <b><span data-icon="lightbulb" data-icon-size="18" style="display:inline-flex;vertical-align:-3px;margin-right:4px"></span>ホーム画面への追加を推奨</b>
      Safari → 共有ボタン → 「ホーム画面に追加」でアプリとして利用できます。<br>
      データの長期保持にも効果的です。
    </div>
    <div class="scard">
      <div class="scard-t">データ同期</div>
      <div class="scard-d">サーバーから最新データを取得します。通常はページ読み込み時に自動同期されます。</div>
      <button class="btn btn-p btn-bl" onclick="fetchLatestData()">今すぐ同期</button>
      <div class="scard-m" id="syncInfo">最終同期: ---</div>
    </div>
    <div class="scard">
      <div class="scard-t">CSVインポート（手動）</div>
      <div class="scard-d">ネットワーク接続がない場合やCSVファイルを直接読み込みたい場合に使用します。</div>
      <input type="file" id="cf" accept=".csv" style="display:none" onchange="importCSV(this)">
      <button class="btn btn-p btn-bl" onclick="document.getElementById('cf').click()">CSVファイルを選択</button>
      <div class="scard-m" id="im">現在: 0件</div>
    </div>
    <div class="scard">
      <div class="scard-t">CSVエクスポート</div>
      <div class="scard-d">バックアップ用にCSVファイルをダウンロードします。定期的な保存を推奨します。</div>
      <button class="btn btn-ok btn-bl" onclick="exportCSV()">CSVをエクスポート</button>
    </div>
    <div class="scard">
      <div class="scard-t">ストレージ使用量</div>
      <div class="scard-m" id="sto">計算中...</div>
      <div class="sbar"><div class="sbar-f" id="sbf" style="width:0%"></div></div>
    </div>
    <div class="scard">
      <div class="scard-t" style="color:var(--red);display:flex;align-items:center;gap:6px"><span data-icon="alert-triangle" data-icon-size="18"></span>データ削除</div>
      <div class="scard-d">すべてのデータを削除します。この操作は元に戻せません。</div>
      <button class="btn btn-d btn-bl" onclick="nukeData()">すべて削除</button>
    </div>
    <div style="text-align:center;color:var(--text3);font-size:.75rem;margin-top:24px;line-height:1.8">
      対面サポート支援システム v4.0<br>
      &copy; 2026 株式会社ベスプラ
    </div>
  </div>
</div>

<!-- ===== MODAL ===== -->
<div class="mo" id="mo" role="dialog" aria-modal="true" aria-labelledby="moTitle">
  <div class="mo-c">
    <div class="mo-top">
      <h2 id="moTitle">対応詳細</h2>
      <button class="mo-x" onclick="closeModal()" aria-label="閉じる">×</button>
    </div>
    <div class="mo-bd" id="mob"></div>
  </div>
</div>

<div class="toast" id="tt"></div>

<script>
/* ============================================================
   対面サポート支援システム v4.0 - CRM型ユーザーカルテUI
   ============================================================ */

// ===== CONFIG =====
var CONFIG = {
  passcodeLength: 6,
  verifyData: 'omwlxAe5TKyNT0V74Sk911ComHuw8Gk2Td1r5bk5ISOOg6xdBMShAAiyRZpnpjWLsVsjl+sE',
  verifyPlaintext: 'TAIMEN_SUPPORT_VERIFIED_OK',
  storageKey: 'taimen_v3',
  sessionKey: 'taimen_session',
  passcodeKey: 'taimen_pc',
  pageSize: 50,
  dataUrl: 'data.enc',
  syncKey: 'taimen_last_sync',
  pbkdf2Salt: 'taimen_support_v4_salt_2026',
  pbkdf2Iterations: 100000,
  karteHistoryMax: 20,
  karteHistoryDisplay: 8,
  repeaterDisplay: 15,
  recentDisplay: 5,
  topCategoryDisplay: 8,
  weeklySummaryWeeks: 8,
  toastDuration: 3500,
  similarCasesMax: 3,
  storageLimitBytes: 5 * 1024 * 1024
};

// ===== LUCIDE ICONS (inline SVG) =====
var ICONS = {
  'home': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"/><path d="M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>',
  'user': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
  'search': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21 21-4.34-4.34"/><circle cx="11" cy="11" r="8"/></svg>',
  'bar-chart-3': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v16a2 2 0 0 0 2 2h16"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>',
  'settings': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915"/><circle cx="12" cy="12" r="3"/></svg>',
  'clipboard-list': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>',
  'shield-check': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="m9 12 2 2 4-4"/></svg>',
  'download': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15V3"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="m7 10 5 5 5-5"/></svg>',
  'camera': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z"/><circle cx="12" cy="13" r="3"/></svg>',
  'calendar': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>',
  'clock': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
  'repeat': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>',
  'zap': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"/></svg>',
  'trending-up': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 7h6v6"/><path d="m22 7-8.5 8.5-5-5L2 17"/></svg>',
  'user-plus': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>',
  'map-pin': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"/><circle cx="12" cy="10" r="3"/></svg>',
  'timer': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></svg>',
  'smartphone': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>',
  'users': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><path d="M16 3.128a4 4 0 0 1 0 7.744"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><circle cx="9" cy="7" r="4"/></svg>',
  'calendar-days': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>',
  'lightbulb': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>',
  'alert-triangle': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>',
  'search-x': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m13.5 8.5-5 5"/><path d="m8.5 8.5 5 5"/><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>'
};

function icon(name, size) {
  var svg = ICONS[name] || '';
  if (!svg) return '';
  if (size && size !== 24) {
    svg = svg.replace('width="24"', 'width="' + size + '"').replace('height="24"', 'height="' + size + '"');
  }
  return svg;
}

function initIcons() {
  var els = document.querySelectorAll('[data-icon]');
  for (var i = 0; i < els.length; i++) {
    var name = els[i].getAttribute('data-icon');
    var size = parseInt(els[i].getAttribute('data-icon-size') || '24');
    els[i].innerHTML = icon(name, size);
  }
}

// ===== STATE =====
var STATE = {
  data: [],
  results: [],
  displayCount: CONFIG.pageSize,
  searchMode: 'uid',
  karteHistory: [],
  currentKarteId: null,
  cryptoKey: null,
  userIndex: null,
  userRecords: null
};

// ===== CATEGORY RULES =====
var CATEGORY_RULES = [
  [['スライドパズル','スライド'], 'スライドパズル'],
  [['ジグソーパズル','ジグソー'], 'ジグソーパズル'],
  [['まちがい探し','間違い探し'], 'まちがい探し'],
  [['nバック','n-back','エヌバック'], 'Nバック課題'],
  [['初期化','消えた','消してしまった','アンインストール','削除してしまった','消失'], 'データ復旧・引継ぎ'],
  [['引継ぎ','引き継ぎ','機種変更','移行','データ移行'], 'データ復旧・引継ぎ'],
  [['真っ白','白い画面','起動しない','立ち上がらない','開かない','表示されない','画面が白'], '画面真っ白'],
  [['フリーズ','固まる','重い','落ちる','不具合'], 'アプリ動作・表示不具合'],
  [['歩数','歩数計','万歩','歩行ペース'], '歩数カウント'],
  [['ランキング','順位'], '歩数ランキング'],
  [['ウォーキング','チャレンジ'], 'ウォーキングチャレンジ'],
  [['paypay','ペイペイ'], 'PayPayポイント'],
  [['ポイント','交換','giftee','waon'], 'ポイント申請・交換'],
  [['クーポン'], 'クーポン'],
  [['脳トレ','脳にいい','特別対戦'], '脳トレ機能'],
  [['効果音','音が出'], '脳トレ効果音'],
  [['認知機能','テスト結果'], '認知機能テスト'],
  [['インストール','新規登録','申し込み','申込'], '新規登録'],
  [['ユーザーid','パスワード','ログイン','ログインできない'], 'ID関連'],
  [['qrコード','コード読み取り'], 'QRコード'],
  [['友達紹介','招待','紹介コード'], '友達紹介'],
  [['退会','解約','やめたい'], '退会'],
  [['食事','食材','食事項目'], '食事項目'],
  [['スター','番付'], 'スター'],
  [['スマートウォッチ','ウォッチ'], 'スマートウォッチ'],
  [['かんたん健康','健康管理'], 'かんたん健康管理'],
  [['操作方法','どうやって'], '機能の使い方'],
  [['要望','改善してほしい','希望'], 'ご意見・要望']
];

var ALL_SEARCH_KEYWORDS = (function() {
  var seen = {};
  var result = [];
  CATEGORY_RULES.forEach(function(rule) {
    rule[0].forEach(function(kw) {
      var lower = kw.toLowerCase();
      if (!seen[lower]) { seen[lower] = true; result.push(lower); }
    });
  });
  var extra = ['バッテリー','最適化','通知','更新','エラー','設定','再起動',
    'パスワード','アカウント','歩数','ポイント','交換','登録','申込',
    '画面','白い','真っ白','固まる','落ちる','インストール','バージョン',
    'wifi','bluetooth','gps','位置情報','同期','データ','写真','カメラ',
    '音','音声','android','iphone','ios','pixel','aquos','xperia','galaxy','oppo',
    'アンバサダー','ウォーキング','チャレンジ','ランキング','脳トレ',
    'スライドパズル','ジグソー','まちがい探し','nバック','paypay'];
  extra.forEach(function(kw) {
    var lower = kw.toLowerCase();
    if (!seen[lower]) { seen[lower] = true; result.push(lower); }
  });
  return result;
})();

function categorize(text) {
  if (!text) return 'その他・一般';
  var s = String(text).toLowerCase();
  for (var i = 0; i < CATEGORY_RULES.length; i++) {
    var keywords = CATEGORY_RULES[i][0];
    var category = CATEGORY_RULES[i][1];
    for (var j = 0; j < keywords.length; j++) {
      if (s.indexOf(keywords[j].toLowerCase()) !== -1) return category;
    }
  }
  return 'その他・一般';
}

function compareByDateDesc(a, b) {
  return (b.date || '').localeCompare(a.date || '') ||
    (b.startTime || '').localeCompare(a.startTime || '');
}

// ===== DEVICE NORMALIZATION =====
function normalizeDevice(raw) {
  if (!raw) return '不明';
  var d = String(raw).replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
  d = d.replace(/Andoroid/gi, 'Android').replace(/Androud/gi, 'Android');
  return d;
}

function simplifyDevice(raw) {
  var d = normalizeDevice(raw).toUpperCase();
  if (d.indexOf('IPHONE') !== -1 || d.indexOf('IOS') !== -1) return 'iPhone';
  if (d.indexOf('AQUOS') !== -1) return 'AQUOS';
  if (d.indexOf('XPERIA') !== -1) return 'Xperia';
  if (d.indexOf('PIXEL') !== -1) return 'Pixel';
  if (d.indexOf('GALAXY') !== -1) return 'Galaxy';
  if (d.indexOf('OPPO') !== -1) return 'OPPO';
  if (d.indexOf('京セラ') !== -1 || d.indexOf('KYOCERA') !== -1 || d.indexOf('BASIO') !== -1 || d.indexOf('TORQUE') !== -1) return '京セラ';
  if (d.indexOf('ARROWS') !== -1 || d.indexOf('らくらく') !== -1 || d.indexOf('FCNT') !== -1 || d.indexOf('F-51') !== -1 || d.indexOf('F-52') !== -1 || d.indexOf('F53') !== -1 || d.indexOf('楽々') !== -1) return 'arrows/らくスマ';
  if (d.indexOf('XIAOMI') !== -1 || d.indexOf('REDMI') !== -1) return 'Xiaomi';
  if (d.indexOf('HUAWEI') !== -1) return 'Huawei';
  if (d.indexOf('シニア') !== -1 || d.indexOf('かんたん') !== -1) return 'かんたんスマホ';
  if (d.indexOf('ANDROID') !== -1) return 'その他Android';
  if (d === '不明' || d === '未確認' || d === 'NAN') return '不明';
  return d;
}

// ===== STAFF NORMALIZATION =====
function normalizeStaff(raw) {
  if (!raw || raw === 'nan') return '';
  var s = String(raw).replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
  s = s.replace(/様$/g, '').replace(/説明者[（(]/g, '').replace(/[）)]/g, '').replace(/↓/g, ',');
  s = s.replace(/\s+/g, ',').replace(/,+/g, ',').replace(/^,|,$/g, '');
  return s;
}

// ===== PERSONAL NAME MASK =====
function maskName(text) {
  if (!text) return '';
  return text.replace(/([一-龥ぁ-んァ-ヶ]{1,6})(様|さん|氏)/g, function(match, name, suffix) {
    var exceptions = ['皆','開発','担当','弊社','御社','当社','本人','市役所','自治体',
      '遠山','ベスプラ','掛川','南口','八王子','てくポ','脳にいい'];
    for (var i = 0; i < exceptions.length; i++) {
      if (name.indexOf(exceptions[i]) !== -1) return match;
    }
    return '***' + suffix;
  });
}

// ===== ESCALATION / MEDIA DETECTION =====
function hasEscalation(rec) {
  var t = ((rec.response || '') + ' ' + (rec.notes || '')).toLowerCase();
  return t.indexOf('遠山') !== -1;
}

function hasMediaCapture(rec) {
  var t = ((rec.response || '') + ' ' + (rec.notes || '')).toLowerCase();
  return t.indexOf('スクリーンショット') !== -1 || t.indexOf('スクショ') !== -1 ||
    t.indexOf('動画') !== -1 || t.indexOf('撮影') !== -1 || t.indexOf('写真') !== -1;
}

// ===== SIMILAR CASES =====
function extractKeywords(text) {
  if (!text) return [];
  var s = String(text).toLowerCase();
  var found = [];
  for (var i = 0; i < ALL_SEARCH_KEYWORDS.length; i++) {
    if (s.indexOf(ALL_SEARCH_KEYWORDS[i]) !== -1) {
      found.push(ALL_SEARCH_KEYWORDS[i]);
    }
  }
  return found;
}

function findSimilarCases(rec, maxResults) {
  maxResults = maxResults || CONFIG.similarCasesMax;
  if (!rec || !rec.complaint) return [];
  var srcKeywords = extractKeywords(rec.complaint + ' ' + (rec.response || ''));
  var srcCategory = rec.category;
  if (srcKeywords.length === 0 && (!srcCategory || srcCategory === 'その他・一般')) return [];

  var scored = [];
  for (var i = 0; i < STATE.data.length; i++) {
    var r = STATE.data[i];
    // 自分自身を除外（日付+時間+UserIDで判定）
    if (r.date === rec.date && r.startTime === rec.startTime && r.userId === rec.userId) continue;
    // 同一ユーザーの別記録は除外（カルテで見えるので）
    if (rec.userId && isValidUserId(rec.userId) && r.userId === rec.userId) continue;

    var score = 0;
    // カテゴリ一致で+3
    if (srcCategory && srcCategory !== 'その他・一般' && r.category === srcCategory) score += 3;

    // キーワード一致でスコア加算
    var targetText = r.searchTextLower || ((r.complaint || '') + ' ' + (r.response || '')).toLowerCase();
    for (var j = 0; j < srcKeywords.length; j++) {
      if (targetText.indexOf(srcKeywords[j]) !== -1) score += 1;
    }

    if (score >= 2) {
      scored.push({ record: r, score: score, index: i });
    }
  }

  // スコア降順、同スコアなら新しい日付優先
  scored.sort(function(a, b) {
    if (b.score !== a.score) return b.score - a.score;
    return (b.record.date || '').localeCompare(a.record.date || '');
  });

  return scored.slice(0, maxResults);
}

function renderSimilarCases(rec) {
  var similar = findSimilarCases(rec);
  if (similar.length === 0) return '';
  var html = '<div class="sim-cases">';
  html += '<div class="sim-cases-t">' + icon('lightbulb', 18) + ' 類似事例（' + similar.length + '件）</div>';
  similar.forEach(function(entry) {
    var r = entry.record;
    var idx = entry.index;
    html += '<div class="sim-case" onclick="closeModal();openModal(' + idx + ')">';
    html += '<div class="sim-case-header">';
    html += '<span class="tg tg-dt">' + formatDate(r.date) + '</span>';
    html += '<span class="tg tg-ct">' + escHtml(r.category) + '</span>';
    html += '<span class="tg tg-dv">' + escHtml(r.deviceSimple || '不明') + '</span>';
    html += '</div>';
    html += '<div class="sim-case-text">' + escHtml(maskName(truncate(r.complaint, 60))) + '</div>';
    if (r.response) {
      html += '<div class="sim-case-response"><b>→ 対応:</b> ' + escHtml(maskName(truncate(r.response, 80))) + '</div>';
    }
    html += '</div>';
  });
  html += '</div>';
  return html;
}

// ===== CSV PARSER (RFC 4180) =====
function parseCSV(text) {
  if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
  var records = [];
  var fields = [], field = '', inQuotes = false;
  for (var i = 0; i < text.length; i++) {
    var c = text[i];
    if (inQuotes) {
      if (c === '"') {
        if (text[i + 1] === '"') { field += '"'; i++; }
        else inQuotes = false;
      } else {
        field += c;
      }
    } else {
      if (c === '"') { inQuotes = true; }
      else if (c === ',') { fields.push(field); field = ''; }
      else if (c === '\n' || (c === '\r' && text[i + 1] === '\n')) {
        fields.push(field); field = '';
        if (c === '\r') i++;
        records.push(fields); fields = [];
      } else if (c === '\r') {
        fields.push(field); field = '';
        records.push(fields); fields = [];
      } else {
        field += c;
      }
    }
  }
  fields.push(field);
  if (fields.some(function(f) { return f.trim(); })) records.push(fields);
  return records;
}

function csvToRecords(csvText) {
  var rows = parseCSV(csvText);
  if (rows.length < 2) return [];
  var header = rows[0].map(function(h) { return h.trim(); });
  var colMap = {};
  header.forEach(function(h, i) { colMap[h] = i; });
  function getField(row, key) {
    var idx = colMap[key];
    var val = (idx !== undefined && row[idx]) ? row[idx].trim() : '';
    return (val === 'nan' || val === 'NaN') ? '' : val;
  }
  var records = [];
  for (var r = 1; r < rows.length; r++) {
    var row = rows[r];
    if (!row || row.length < 6) continue;
    var get = function(key) { return getField(row, key); };
    var date = get('日付');
    if (!date || date === 'nan') continue;
    var userId = get('UserID');
    if (['以下、余白', 'nan', '以下余白', '項番'].some(function(v) { return userId.indexOf(v) !== -1; })) userId = '';
    if (['未確認', '確認漏れ', '失念', '未登録', '不明'].some(function(v) { return userId === v; })) userId = '';
    var rec = {
      no: get('No'),
      date: date,
      startTime: get('開始時間'),
      endTime: get('終了時間'),
      duration: get('対応時間'),
      userId: userId,
      device: normalizeDevice(get('機種')),
      deviceSimple: simplifyDevice(get('機種')),
      gender: (get('性別') === 'nan' ? '' : get('性別')),
      complaint: get('相談内容'),
      response: get('対応内容'),
      notes: get('特記事項'),
      staff: normalizeStaff(get('担当')),
      location: get('場所'),
      importDate: get('インポート日'),
      category: ''
    };
    rec.category = categorize(rec.complaint + ' ' + rec.response);
    rec.searchTextLower = ((rec.complaint || '') + ' ' + (rec.response || '') + ' ' + (rec.notes || '')).toLowerCase();
    records.push(rec);
  }
  return records;
}

// ===== DATA MANAGEMENT =====
function loadData() {
  try {
    var raw = localStorage.getItem(CONFIG.storageKey);
    if (raw) {
      var parsed = JSON.parse(raw);
      STATE.data = parsed.records || [];
    }
  } catch (e) {
    STATE.data = [];
    console.error('loadData error:', e);
    toast('データの読み込みに失敗しました', 'er');
  }
  buildUserIndex();
}

function saveData() {
  try {
    localStorage.setItem(CONFIG.storageKey, JSON.stringify({
      version: 4,
      timestamp: new Date().toISOString(),
      count: STATE.data.length,
      records: STATE.data
    }));
  } catch (e) {
    console.error('saveData error:', e);
    if (e.name === 'QuotaExceededError' || e.code === 22) {
      toast('ストレージ容量不足です。設定画面でデータをエクスポートしてください', 'er');
    } else {
      toast('データの保存に失敗しました', 'er');
    }
  }
}

function mergeData(newRecords) {
  // 新規レコードから「場所+日付」の組み合わせを抽出
  var newSlots = {};
  for (var i = 0; i < newRecords.length; i++) {
    var r = newRecords[i];
    var slot = (r.location || '') + '|' + r.date;
    newSlots[slot] = true;
  }
  // 該当する場所+日付の既存データを除去（上書き準備）
  var removed = 0;
  var kept = [];
  for (var j = 0; j < STATE.data.length; j++) {
    var d = STATE.data[j];
    var dSlot = (d.location || '') + '|' + d.date;
    if (newSlots[dSlot]) {
      removed++;
    } else {
      kept.push(d);
    }
  }
  // 新規レコードを追加
  STATE.data = kept.concat(newRecords);
  STATE.data.sort(compareByDateDesc);
  saveData();
  buildUserIndex();
  return { added: newRecords.length, removed: removed };
}

// ===== CRYPTO: PBKDF2 + AES-GCM =====
function deriveKey(passcode) {
  var enc = new TextEncoder();
  var saltBytes = enc.encode(CONFIG.pbkdf2Salt);
  return crypto.subtle.importKey(
    'raw', enc.encode(passcode), 'PBKDF2', false, ['deriveKey']
  ).then(function(baseKey) {
    return crypto.subtle.deriveKey(
      { name: 'PBKDF2', salt: saltBytes, iterations: CONFIG.pbkdf2Iterations, hash: 'SHA-256' },
      baseKey,
      { name: 'AES-GCM', length: 256 },
      false,
      ['decrypt']
    );
  });
}

function decryptData(key, b64Data) {
  var binaryStr = atob(b64Data);
  var bytes = new Uint8Array(binaryStr.length);
  for (var i = 0; i < binaryStr.length; i++) bytes[i] = binaryStr.charCodeAt(i);
  var iv = bytes.slice(0, 12);
  var ciphertext = bytes.slice(12);
  return crypto.subtle.decrypt(
    { name: 'AES-GCM', iv: iv },
    key,
    ciphertext
  ).then(function(plainBuf) {
    return new TextDecoder().decode(plainBuf);
  });
}

function fetchLatestData() {
  if (!STATE.cryptoKey) return;
  var syncIndicator = document.getElementById('syncStatus');
  if (syncIndicator) syncIndicator.textContent = '同期中...';

  var controller = new AbortController();
  var timeoutId = setTimeout(function() { controller.abort(); }, 15000);

  fetch(CONFIG.dataUrl, { cache: 'no-store', signal: controller.signal })
    .then(function(res) {
      clearTimeout(timeoutId);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.text();
    })
    .then(function(b64Data) {
      return decryptData(STATE.cryptoKey, b64Data.trim());
    })
    .then(function(csvText) {
      var records = csvToRecords(csvText);
      if (!records.length) { toast('復号成功、有効レコードなし', 'i'); return; }
      var before = STATE.data.length;
      var result = mergeData(records);
      var now = new Date().toISOString();
      localStorage.setItem(CONFIG.syncKey, now);
      if (syncIndicator) syncIndicator.textContent = '最終同期: ' + formatSyncTime(now);
      if (result.added > 0) {
        var msg = result.added + '件を反映';
        if (result.removed > 0) msg += '（' + result.removed + '件を上書き更新）';
        msg += '　合計' + STATE.data.length + '件';
        toast(msg, 'ok');
        refreshAll();
      } else if (before === 0) {
        toast(records.length + '件のデータを読み込みました', 'ok');
        refreshAll();
      } else {
        toast('データは最新です（' + STATE.data.length + '件）', 'i');
      }
    })
    .catch(function(err) {
      clearTimeout(timeoutId);
      var msg = String(err.message || err);
      if (err.name === 'AbortError') {
        toast('データ取得がタイムアウトしました', 'er');
      } else if (msg.indexOf('Failed to fetch') !== -1 || msg.indexOf('NetworkError') !== -1 || msg.indexOf('HTTP') !== -1) {
        if (STATE.data.length > 0) {
          toast('オフラインモード: 前回のデータを表示中', 'i');
        } else {
          toast('ネットワーク接続を確認してください', 'er');
        }
      } else if (msg.indexOf('OperationError') !== -1) {
        toast('復号に失敗しました（パスコード不一致またはデータ破損）', 'er');
      } else {
        toast('データ取得に失敗: ' + msg.substring(0, 50), 'er');
        console.error('fetchLatestData error:', err);
      }
      var lastSync = localStorage.getItem(CONFIG.syncKey);
      if (syncIndicator && lastSync) syncIndicator.textContent = '最終同期: ' + formatSyncTime(lastSync);
      else if (syncIndicator) syncIndicator.textContent = '未同期';
    });
}

function formatSyncTime(isoStr) {
  try {
    var d = new Date(isoStr);
    return (d.getMonth() + 1) + '/' + d.getDate() + ' ' + String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
  } catch(e) { return isoStr; }
}

// ===== REPEATER DETECTION =====
var INVALID_UIDS = ['未確認', '確認漏れ', '失念しました', 'ー', '未登録', ''];
function isValidUserId(uid) {
  if (!uid) return false;
  if (INVALID_UIDS.indexOf(uid) !== -1) return false;
  if (uid.indexOf('項番') !== -1 || uid.indexOf('余白') !== -1) return false;
  return true;
}

function getRepeatCount(userId) {
  if (!isValidUserId(userId)) return 0;
  return STATE.userIndex ? (STATE.userIndex[userId] || 0) : 0;
}

function getRepeatUsers() {
  if (!STATE.userIndex) return [];
  return Object.keys(STATE.userIndex)
    .filter(function(k) { return STATE.userIndex[k] > 1; })
    .map(function(k) { return [k, STATE.userIndex[k]]; })
    .sort(function(a, b) { return b[1] - a[1]; });
}

// ===== USER INDEX (PERFORMANCE) =====
function buildUserIndex() {
  STATE.userIndex = {};
  STATE.userRecords = {};
  for (var i = 0; i < STATE.data.length; i++) {
    var r = STATE.data[i];
    if (isValidUserId(r.userId)) {
      STATE.userIndex[r.userId] = (STATE.userIndex[r.userId] || 0) + 1;
      if (!STATE.userRecords[r.userId]) STATE.userRecords[r.userId] = [];
      STATE.userRecords[r.userId].push(r);
    }
  }
}

// ===== KARTE (NEW) =====
function buildKarte(userId) {
  var records = STATE.data
    .filter(function(r) { return r.userId === userId; })
    .sort(compareByDateDesc);
  if (!records.length) return null;

  var latest = records[0];
  var oldest = records[records.length - 1];

  // Category counts
  var categories = {};
  var staffCounts = {};
  var escalationCount = 0;
  var escalationRecords = [];
  var mediaCount = 0;
  var totalMinutes = 0;
  var durationCount = 0;

  records.forEach(function(r) {
    categories[r.category] = (categories[r.category] || 0) + 1;
    if (r.staff) {
      r.staff.split(',').forEach(function(s) {
        var name = s.trim();
        if (name && name !== 'nan') staffCounts[name] = (staffCounts[name] || 0) + 1;
      });
    }
    if (hasEscalation(r)) { escalationCount++; escalationRecords.push(r); }
    if (hasMediaCapture(r)) mediaCount++;
    if (r.duration) {
      var m = parseDuration(r.duration);
      if (m > 0) { totalMinutes += m; durationCount++; }
    }
  });

  var avgDuration = durationCount > 0 ? Math.round(totalMinutes / durationCount) : 0;

  // Summary text
  var summary = '';
  if (latest.category && latest.category !== 'その他・一般') {
    summary = '前回は「' + latest.category + '」で来店';
  } else if (latest.complaint) {
    summary = '前回: ' + truncate(latest.complaint, 40);
  }

  return {
    userId: userId,
    records: records,
    latestRecord: latest,
    device: latest.device,
    deviceSimple: latest.deviceSimple,
    gender: (latest.gender && latest.gender !== 'nan' ? latest.gender : '') || (oldest.gender && oldest.gender !== 'nan' ? oldest.gender : ''),
    visitCount: records.length,
    firstVisit: oldest.date,
    lastVisit: latest.date,
    categories: categories,
    escalationCount: escalationCount,
    escalationRecords: escalationRecords,
    mediaCount: mediaCount,
    avgDuration: avgDuration,
    staffCounts: staffCounts,
    summary: summary
  };
}

function parseDuration(dur) {
  if (!dur) return 0;
  var s = String(dur).trim();
  if (!s) return 0;
  // "0:37:00" or "1:05:30" format (H:MM:SS)
  var match = s.match(/^(\d+):(\d+):(\d+)$/);
  if (match) return parseInt(match[1], 10) * 60 + parseInt(match[2], 10);
  // "0:37" format (H:MM)
  match = s.match(/^(\d+):(\d+)$/);
  if (match) return parseInt(match[1], 10) * 60 + parseInt(match[2], 10);
  // "1時間37分" format
  match = s.match(/(\d+)\s*時間\s*(\d+)\s*分/);
  if (match) return parseInt(match[1], 10) * 60 + parseInt(match[2], 10);
  // "1時間" format (no minutes part)
  match = s.match(/(\d+)\s*時間/);
  if (match) return parseInt(match[1], 10) * 60;
  // "37分" format
  match = s.match(/(\d+)\s*分/);
  if (match) return parseInt(match[1], 10);
  // "37" plain number (assumed minutes)
  var n = parseInt(s, 10);
  return isNaN(n) ? 0 : n;
}

function renderKarte(kd) {
  var h = '';

  // Back button
  h += '<button class="k-back" onclick="showKarteInit()">&larr; ユーザー検索に戻る</button>';

  // Highlight panel
  h += '<div class="k-highlight">';
  h += '<div class="k-hl-id">' + escHtml(kd.userId) + '</div>';
  h += '<div class="k-hl-meta">';
  h += '<span>' + escHtml(kd.deviceSimple || '不明') + (kd.device !== kd.deviceSimple ? ' (' + escHtml(kd.device) + ')' : '') + '</span>';
  if (kd.gender && kd.gender !== 'nan') h += '<span>' + escHtml(kd.gender) + '</span>';
  h += '</div>';
  h += '<div class="k-hl-tags">';
  h += '<span class="k-hl-tag">' + icon('repeat', 14) + ' 来訪' + kd.visitCount + '回目</span>';
  h += '<span class="k-hl-tag">初回: ' + formatDate(kd.firstVisit) + '</span>';
  h += '<span class="k-hl-tag">最終: ' + formatDate(kd.lastVisit) + '</span>';
  // Category tags (top 3)
  var catEntries = Object.keys(kd.categories).map(function(k) { return [k, kd.categories[k]]; }).sort(function(a, b) { return b[1] - a[1]; });
  catEntries.slice(0, 3).forEach(function(e) {
    h += '<span class="k-hl-tag">' + escHtml(e[0]) + ':' + e[1] + '</span>';
  });
  if (kd.escalationCount > 0) {
    h += '<span class="k-hl-tag esc">' + icon('zap', 14) + ' エスカレ ' + kd.escalationCount + '件</span>';
  }
  h += '</div></div>';

  // Previous visit card (most prominent)
  var prev = kd.latestRecord;
  h += '<div class="k-prev">';
  h += '<div class="k-prev-t">' + icon('clipboard-list', 18) + ' 前回の対応</div>';
  h += '<div class="k-prev-cat">' + formatDate(prev.date) + ' ' + escHtml(prev.category) + '</div>';
  h += '<div class="k-prev-staff">担当: ' + escHtml(prev.staff || '記録なし') + (prev.duration ? ' | 対応時間: ' + escHtml(prev.duration) : '') + '</div>';
  var prevText = '';
  if (prev.complaint) prevText += maskName(prev.complaint);
  if (prev.response) prevText += '\n→ ' + maskName(prev.response);
  h += '<div class="k-prev-body">' + escHtml(prevText) + '</div>';
  if (hasEscalation(prev)) h += '<div style="margin-top:8px"><span class="tg tg-esc">' + icon('zap', 14) + 'エスカレ</span></div>';
  if (hasMediaCapture(prev)) h += '<div style="margin-top:4px"><span class="tg tg-media">' + icon('camera', 14) + '撮影あり</span></div>';
  h += '</div>';

  // Stats row (2 columns)
  h += '<div class="k-stats">';
  // Left: Stats
  h += '<div class="k-stat-card"><h4>対応統計</h4>';
  h += '<div class="k-stat-row"><span>平均対応時間</span><span class="k-stat-val">' + (kd.avgDuration > 0 ? kd.avgDuration + '分' : '---') + '</span></div>';
  h += '<div class="k-stat-row"><span>エスカレ回数</span><span class="k-stat-val">' + kd.escalationCount + '件</span></div>';
  h += '<div class="k-stat-row"><span>撮影記録</span><span class="k-stat-val">' + kd.mediaCount + '件</span></div>';
  // Staff breakdown
  var staffKeys = Object.keys(kd.staffCounts).sort(function(a, b) { return kd.staffCounts[b] - kd.staffCounts[a]; });
  if (staffKeys.length) {
    h += '<div class="k-stat-row"><span>担当者</span><span class="k-stat-val">' +
      staffKeys.map(function(s) { return escHtml(s) + '(' + kd.staffCounts[s] + ')'; }).join(' ') + '</span></div>';
  }
  h += '</div>';

  // Right: Category breakdown
  h += '<div class="k-stat-card"><h4>相談カテゴリ内訳</h4>';
  var maxCat = catEntries.length > 0 ? catEntries[0][1] : 1;
  catEntries.forEach(function(e) {
    var pct = Math.round((e[1] / maxCat) * 100);
    h += '<div class="k-stat-row"><span style="flex-shrink:0">' + escHtml(e[0]) + '</span>';
    h += '<div class="k-cat-bar"><div class="k-cat-fill" style="width:' + pct + '%"></div></div>';
    h += '<span class="k-stat-val">' + e[1] + '件</span></div>';
  });
  h += '</div></div>';

  // Timeline
  h += '<div class="card"><div class="card-t"><span class="ct-ico">' + icon('calendar', 20) + '</span>対応タイムライン</div>';
  h += '<div class="tl">';
  kd.records.forEach(function(rec, idx) {
    var esc = hasEscalation(rec);
    var media = hasMediaCapture(rec);
    h += '<div class="tl-item" id="tl-' + idx + '">';
    h += '<div class="tl-dot' + (esc ? ' esc' : '') + '"></div>';
    h += '<div class="tl-head" onclick="toggleTl(' + idx + ')">';
    h += '<span class="tl-arrow">▶</span> ';
    h += '<span class="tl-date">' + formatDate(rec.date) + '</span> ';
    h += '<span class="tg tg-ct" style="margin-left:4px">' + escHtml(rec.category) + '</span> ';
    if (esc) h += '<span class="tg tg-esc" style="margin-left:2px">' + icon('zap', 14) + 'エスカレ</span> ';
    if (media) h += '<span class="tg tg-media" style="margin-left:2px">' + icon('camera', 14) + '</span> ';
    if (rec.staff) h += '<span style="font-size:.82rem;color:var(--text2);margin-left:auto">担当: ' + escHtml(rec.staff) + '</span>';
    h += '</div>';
    h += '<div class="tl-body">';
    h += '<div class="dl"><div class="dl-l">相談内容</div><div class="dl-v">' + escHtml(maskName(rec.complaint || 'なし')) + '</div></div>';
    h += '<div class="dl"><div class="dl-l">対応内容</div><div class="dl-v">' + escHtml(maskName(rec.response || 'なし')) + '</div></div>';
    if (rec.notes && rec.notes !== 'nan' && rec.notes.trim()) {
      h += '<div class="dl"><div class="dl-l">特記事項</div><div class="dl-v">' + escHtml(maskName(rec.notes)) + '</div></div>';
    }
    h += '<div style="margin-top:8px;font-size:.82rem;color:var(--text3)">';
    h += '時間: ' + escHtml(rec.startTime || '') + ' - ' + escHtml(rec.endTime || '') + (rec.duration ? ' (' + escHtml(rec.duration) + ')' : '');
    if (rec.location) h += ' | 場所: ' + escHtml(rec.location);
    h += '</div></div></div>';
  });
  h += '</div></div>';

  return h;
}

function showKarte(userId) {
  if (!userId) return;
  var cleanId = userId.replace(/[-\s]/g, '');
  // Find exact match first, then partial
  var exactRecs = STATE.data.filter(function(r) { return r.userId.replace(/[-\s]/g, '') === cleanId; });
  var targetId = exactRecs.length > 0 ? exactRecs[0].userId : null;

  if (!targetId) {
    // Partial match
    var partialRecs = STATE.data.filter(function(r) { return r.userId.replace(/[-\s]/g, '').indexOf(cleanId) !== -1; });
    if (partialRecs.length > 0) {
      targetId = partialRecs[0].userId;
    }
  }

  if (!targetId) {
    toast('該当するユーザーが見つかりません', 'i');
    return;
  }

  var kd = buildKarte(targetId);
  if (!kd) {
    toast('カルテデータを構築できません', 'er');
    return;
  }

  STATE.currentKarteId = targetId;

  // Add to history
  var histIdx = STATE.karteHistory.indexOf(targetId);
  if (histIdx !== -1) STATE.karteHistory.splice(histIdx, 1);
  STATE.karteHistory.unshift(targetId);
  if (STATE.karteHistory.length > CONFIG.karteHistoryMax) STATE.karteHistory.pop();
  try { localStorage.setItem('karte_history', JSON.stringify(STATE.karteHistory)); } catch(e) { console.warn('カルテ履歴の保存に失敗:', e.message); }

  document.getElementById('karteInit').style.display = 'none';
  document.getElementById('karteView').style.display = 'block';
  document.getElementById('karteView').innerHTML = renderKarte(kd);
  window.scrollTo(0, 0);
}

function showKarteInit() {
  STATE.currentKarteId = null;
  document.getElementById('karteView').style.display = 'none';
  document.getElementById('karteInit').style.display = 'block';
  document.getElementById('karteId').value = '';
  renderKarteInit();
  window.scrollTo(0, 0);
}

function renderKarteInit() {
  // Load history
  try {
    var saved = localStorage.getItem('karte_history');
    if (saved) STATE.karteHistory = JSON.parse(saved);
  } catch(e) { STATE.karteHistory = []; console.warn('カルテ履歴の読み込みに失敗:', e.message); }

  // Recent searches
  var recentDiv = document.getElementById('karteRecent');
  if (STATE.karteHistory.length > 0) {
    var rh = '<div class="card"><div class="card-t"><span class="ct-ico">' + icon('clock', 20) + '</span>最近検索したユーザー</div>';
    STATE.karteHistory.slice(0, 8).forEach(function(uid) {
      var recs = STATE.data.filter(function(r) { return r.userId === uid; });
      if (!recs.length) return;
      var latest = recs.sort(compareByDateDesc)[0];
      rh += '<div class="rep-item" onclick="showKarte(\'' + escAttr(uid) + '\')">';
      rh += '<div><div class="rep-id">' + escHtml(uid) + '</div>';
      rh += '<div class="rep-info">' + escHtml(latest.deviceSimple || '不明') + ' | ' + formatDate(latest.date) + ' | ' + escHtml(latest.category) + '</div></div>';
      rh += '<span class="rep-count">' + recs.length + '回</span></div>';
    });
    rh += '</div>';
    recentDiv.innerHTML = rh;
  } else {
    recentDiv.innerHTML = '';
  }

  // Repeaters
  var repDiv = document.getElementById('karteRepeaters');
  var repeaters = getRepeatUsers();
  if (repeaters.length > 0) {
    var rp = '<div class="card"><div class="card-t"><span class="ct-ico">' + icon('repeat', 20) + '</span>リピーター一覧（' + repeaters.length + '名）</div>';
    repeaters.slice(0, 15).forEach(function(entry) {
      var uid = entry[0];
      var count = entry[1];
      var recs = STATE.data.filter(function(r) { return r.userId === uid; });
      var latest = recs.sort(compareByDateDesc)[0];
      rp += '<div class="rep-item" onclick="showKarte(\'' + escAttr(uid) + '\')">';
      rp += '<div><div class="rep-id">' + escHtml(uid) + '</div>';
      rp += '<div class="rep-info">' + escHtml(latest.deviceSimple || '不明') + ' | 最終: ' + formatDate(latest.date) + '</div></div>';
      rp += '<span class="rep-count">' + count + '回</span></div>';
    });
    if (repeaters.length > 15) {
      rp += '<div style="text-align:center;padding:12px;font-size:.85rem;color:var(--text3)">他 ' + (repeaters.length - 15) + '名</div>';
    }
    rp += '</div>';
    repDiv.innerHTML = rp;
  } else {
    repDiv.innerHTML = '';
  }
}

function toggleTl(idx) {
  var el = document.getElementById('tl-' + idx);
  if (el) el.classList.toggle('open');
}

// ===== LOGIN =====
var passcodeInput = '';

function nd(digit) {
  if (passcodeInput.length >= CONFIG.passcodeLength) return;
  passcodeInput += digit;
  updateDots();
  if (passcodeInput.length === CONFIG.passcodeLength) setTimeout(checkPasscode, 200);
}

function ndel() {
  passcodeInput = passcodeInput.slice(0, -1);
  updateDots();
  document.getElementById('lerr').textContent = '';
}

function updateDots() {
  for (var i = 0; i < CONFIG.passcodeLength; i++) {
    var dot = document.getElementById('d' + i);
    if (dot) {
      dot.classList.toggle('on', i < passcodeInput.length);
      dot.classList.remove('err');
    }
  }
}

function checkPasscode() {
  var entered = passcodeInput;
  document.getElementById('lerr').textContent = '認証中...';
  deriveKey(entered).then(function(key) {
    return decryptData(key, CONFIG.verifyData).then(function(plaintext) {
      if (plaintext === CONFIG.verifyPlaintext) {
        STATE.cryptoKey = key;
        sessionStorage.setItem(CONFIG.sessionKey, '1');
        showApp();
      } else {
        throw new Error('mismatch');
      }
    });
  }).catch(function() {
    for (var i = 0; i < CONFIG.passcodeLength; i++) {
      var dot = document.getElementById('d' + i);
      if (dot) dot.classList.add('err');
    }
    document.getElementById('lerr').textContent = 'パスコードが違います';
    setTimeout(function() { passcodeInput = ''; updateDots(); }, 600);
  });
}

function showApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  loadData();
  refreshAll();
  // sessionStorageにパスコードは保存しない（セキュリティ対策）
  // CryptoKeyが既にSTATEにあればそれを使う、なければfetchしない
  if (STATE.cryptoKey) {
    fetchLatestData();
  }
  // CryptoKeyがない場合（ページリロード後）は再ログインが必要
  // localStorageのキャッシュデータは上のloadData()で表示済み
}

function logout() {
  sessionStorage.removeItem(CONFIG.sessionKey);
  STATE.cryptoKey = null;
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  passcodeInput = '';
  updateDots();
  document.getElementById('lerr').textContent = '';
}

// ===== FILE OPERATIONS =====
function importCSV(input) {
  var file = input.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var records = csvToRecords(e.target.result);
      if (!records.length) { toast('有効なレコードが見つかりません', 'er'); return; }
      var result = mergeData(records);
      var msg = result.added + '件を反映';
      if (result.removed > 0) msg += '（' + result.removed + '件を上書き更新）';
      msg += '　合計' + STATE.data.length + '件';
      toast(msg, 'ok');
      refreshAll();
    } catch (err) {
      toast('読み込みに失敗しました: ' + err.message, 'er');
    }
  };
  reader.readAsText(file, 'UTF-8');
  input.value = '';
}

function exportCSV() {
  if (!STATE.data.length) { toast('データがありません', 'er'); return; }
  var headers = ['No','日付','開始時間','終了時間','対応時間','UserID','機種','性別','相談内容','対応内容','特記事項','担当','場所','インポート日'];
  var esc = function(s) { return '"' + (s || '').replace(/"/g, '""') + '"'; };
  var lines = [headers.join(',')];
  for (var i = 0; i < STATE.data.length; i++) {
    var r = STATE.data[i];
    lines.push([
      esc(r.no), esc(r.date), esc(r.startTime), esc(r.endTime), esc(r.duration),
      esc(r.userId), esc(r.device), esc(r.gender),
      esc(r.complaint), esc(r.response), esc(r.notes),
      esc(r.staff), esc(r.location), esc(r.importDate)
    ].join(','));
  }
  var blob = new Blob(['\uFEFF' + lines.join('\n')], { type: 'text/csv;charset=utf-8' });
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'taimen_backup_' + new Date().toISOString().slice(0, 10) + '.csv';
  a.click();
  URL.revokeObjectURL(a.href);
  toast('エクスポートが完了しました', 'ok');
}

function nukeData() {
  if (!confirm('すべてのデータを削除しますか？\nこの操作は元に戻せません。')) return;
  if (!confirm('本当に削除してよろしいですか？\n（最終確認）')) return;
  STATE.data = [];
  localStorage.removeItem(CONFIG.storageKey);
  refreshAll();
  toast('すべてのデータを削除しました', 'i');
}

// ===== SEARCH =====
function setSearchMode(mode) {
  STATE.searchMode = mode;
  var stabs = document.getElementById('searchStabs').querySelectorAll('.stab');
  var modes = ['uid', 'dev', 'kw'];
  for (var i = 0; i < stabs.length; i++) {
    stabs[i].classList.toggle('on', modes[i] === mode);
  }
  modes.forEach(function(m) {
    document.getElementById('m-' + m).style.display = m === mode ? 'block' : 'none';
  });
  clearResults();
}

function doSearch() {
  var mode = STATE.searchMode;
  if (mode === 'uid') {
    var val = (document.getElementById('si-uid').value || '').trim().replace(/[-\s]/g, '');
    if (!val) { toast('ユーザーIDを入力してください', 'i'); return; }
    STATE.results = STATE.data.filter(function(r) {
      return (r.userId || '').replace(/[-\s]/g, '').indexOf(val) !== -1;
    });
  } else if (mode === 'dev') {
    var val2 = (document.getElementById('si-dev').value || '').trim().toLowerCase();
    if (!val2) { toast('機種名を入力してください', 'i'); return; }
    STATE.results = STATE.data.filter(function(r) {
      return (r.device || '').toLowerCase().indexOf(val2) !== -1 ||
        (r.deviceSimple || '').toLowerCase().indexOf(val2) !== -1;
    });
    renderDeviceSummary(val2);
  } else {
    var val3 = (document.getElementById('si-kw').value || '').trim();
    var catFilter = document.getElementById('fc').value;
    var staffFilter = document.getElementById('fs').value;
    var periodFilter = document.getElementById('fp').value;
    var escFilter = document.getElementById('fe').value;
    if (!val3 && !catFilter && !staffFilter && !periodFilter && !escFilter) {
      toast('検索条件を入力してください', 'i'); return;
    }
    var keywords = val3 ? val3.split(/\s+/).filter(Boolean) : [];
    STATE.results = STATE.data.filter(function(r) {
      if (keywords.length) {
        var searchText = (r.complaint + ' ' + r.response + ' ' + r.notes + ' ' + r.device).toLowerCase();
        for (var k = 0; k < keywords.length; k++) {
          if (searchText.indexOf(keywords[k].toLowerCase()) === -1) return false;
        }
      }
      if (catFilter && r.category !== catFilter) return false;
      if (staffFilter && r.staff.indexOf(staffFilter) === -1) return false;
      if (periodFilter) {
        var rd = r.date;
        var now = new Date();
        var y = now.getFullYear();
        var m = String(now.getMonth() + 1).padStart(2, '0');
        if (periodFilter === 'custom') {
          var fromDate = document.getElementById('si-from').value;
          var toDate = document.getElementById('si-to').value;
          if (fromDate && rd < fromDate) return false;
          if (toDate && rd > toDate) return false;
        } else if (periodFilter === 'week') {
          var dayOfWeek = now.getDay() || 7;
          var sw = new Date(now);
          sw.setDate(now.getDate() - dayOfWeek + 1);
          var startWeek = sw.getFullYear() + '-' + String(sw.getMonth() + 1).padStart(2, '0') + '-' + String(sw.getDate()).padStart(2, '0');
          if (rd < startWeek) return false;
        } else if (periodFilter === 'last') {
          var slm = new Date(y, now.getMonth() - 1, 1);
          var elm = new Date(y, now.getMonth(), 0);
          var startLast = slm.getFullYear() + '-' + String(slm.getMonth() + 1).padStart(2, '0') + '-01';
          var endLast = elm.getFullYear() + '-' + String(elm.getMonth() + 1).padStart(2, '0') + '-' + String(elm.getDate()).padStart(2, '0');
          if (rd < startLast || rd > endLast) return false;
        } else if (periodFilter === 'year') {
          if (rd.indexOf(String(y)) !== 0) return false;
        } else {
          var months = parseInt(periodFilter);
          if (months === 1) {
            var startMonth = y + '-' + m + '-01';
            if (rd < startMonth) return false;
          } else {
            var sm = new Date(now);
            sm.setMonth(sm.getMonth() - months);
            var startStr = sm.getFullYear() + '-' + String(sm.getMonth() + 1).padStart(2, '0') + '-' + String(sm.getDate()).padStart(2, '0');
            if (rd < startStr) return false;
          }
        }
      }
      if (escFilter === 'yes' && !hasEscalation(r)) return false;
      if (escFilter === 'no' && hasEscalation(r)) return false;
      return true;
    });
  }
  STATE.results.sort(compareByDateDesc);
  STATE.displayCount = CONFIG.pageSize;
  renderResults();
}

function quickSearch() {
  var val = (document.getElementById('qi').value || '').trim().replace(/[-\s]/g, '');
  if (!val) return;
  var results = STATE.data
    .filter(function(r) { return (r.userId || '').replace(/[-\s]/g, '').indexOf(val) !== -1; })
    .sort(compareByDateDesc);
  var box = document.getElementById('qr');
  if (!results.length) {
    box.innerHTML = '<p style="color:var(--text3);font-size:.88rem;padding:8px 0">該当するレコードがありません</p>';
    return;
  }
  var uid = results[0].userId;
  var repeatCount = results.length;
  var html = '';
  if (repeatCount > 1) {
    html += '<div class="rep-banner">' + icon('repeat', 16) + ' このユーザーは<b> ' + repeatCount + '回目 </b>のご来店です（初回: ' + formatDate(results[results.length - 1].date) + '）</div>';
  }
  html += '<p style="font-size:.88rem;color:var(--text2);margin-bottom:10px"><b>' + results.length + '件</b>の対応履歴</p>';
  var toShowQs = results.slice(0, 5);
  for (var qi = 0; qi < toShowQs.length; qi++) {
    html += renderRecordCard(toShowQs[qi], STATE.data.indexOf(toShowQs[qi]));
  }
  html += '<div style="text-align:center;margin-top:10px;display:flex;gap:8px;justify-content:center">';
  if (results.length > 5) {
    html += '<button class="btn btn-sm btn-g" onclick="goToFullSearch(\'' + escAttr(val) + '\')">全' + results.length + '件を表示</button>';
  }
  html += '<button class="btn btn-sm btn-p" onclick="openKarteFromHome(\'' + escAttr(uid) + '\')">カルテを見る</button>';
  html += '</div>';
  box.innerHTML = html;
}

function openKarteFromHome(uid) {
  go('karte');
  showKarte(uid);
}

function goToFullSearch(uid) {
  go('search');
  setSearchMode('uid');
  document.getElementById('si-uid').value = uid;
  doSearch();
}

function searchByCategory(category) {
  go('search');
  setSearchMode('kw');
  document.getElementById('si-kw').value = '';
  document.getElementById('fc').value = category;
  document.getElementById('fs').value = '';
  document.getElementById('fp').value = '';
  document.getElementById('fe').value = '';
  STATE.results = STATE.data.filter(function(r) { return r.category === category; })
    .sort(compareByDateDesc);
  STATE.displayCount = CONFIG.pageSize;
  renderResults();
}

function searchByPeriod(period) {
  go('search');
  setSearchMode('kw');
  document.getElementById('si-kw').value = '';
  document.getElementById('fc').value = '';
  document.getElementById('fs').value = '';
  document.getElementById('fp').value = period;
  document.getElementById('fe').value = '';
  doSearch();
}

function searchByEscalation() {
  go('search');
  setSearchMode('kw');
  document.getElementById('si-kw').value = '';
  document.getElementById('fc').value = '';
  document.getElementById('fs').value = '';
  document.getElementById('fp').value = '';
  document.getElementById('fe').value = 'yes';
  doSearch();
}

function clearResults() {
  STATE.results = [];
  document.getElementById('sr').innerHTML = '';
  document.getElementById('ri').style.display = 'none';
  document.getElementById('se').style.display = 'block';
  document.getElementById('smore').style.display = 'none';
  document.getElementById('devSummary').innerHTML = '';
}

function showMore() {
  STATE.displayCount += 50;
  renderResults();
}

// ===== RENDER =====
function renderRecordCard(rec, idx) {
  if (idx === undefined) idx = STATE.data.indexOf(rec);
  var date = formatDate(rec.date);
  var esc = hasEscalation(rec);
  var media = hasMediaCapture(rec);
  var repeat = getRepeatCount(rec.userId);
  var summary = maskName(truncate(rec.complaint, 80));

  return '<div class="rc" id="r' + idx + '">' +
    '<div class="rc-h" onclick="toggleCard(' + idx + ')">' +
    '<span class="rc-arrow">▶</span>' +
    '<div class="rc-meta">' +
    '<span class="tg tg-dt">' + date + '</span>' +
    '<span class="tg tg-id">' + escHtml(rec.userId || '---') + '</span>' +
    '<span class="tg tg-dv">' + escHtml(rec.deviceSimple || '不明') + '</span>' +
    '<span class="tg tg-ct">' + escHtml(rec.category) + '</span>' +
    (rec.staff ? '<span class="tg tg-st">' + escHtml(rec.staff) + '</span>' : '') +
    (esc ? '<span class="tg tg-esc">' + icon('zap', 14) + 'エスカレ</span>' : '') +
    (media ? '<span class="tg tg-media">' + icon('camera', 14) + '撮影あり</span>' : '') +
    (repeat > 1 ? '<span class="tg tg-rep">' + icon('repeat', 14) + repeat + '回目</span>' : '') +
    '</div>' +
    '<div class="rc-sum">' + escHtml(summary) + '</div>' +
    '</div>' +
    '<div class="rc-b">' +
    '<div class="dl"><div class="dl-l">相談内容</div><div class="dl-v">' + escHtml(maskName(rec.complaint || 'なし')) + '</div></div>' +
    '<div class="dl"><div class="dl-l">対応内容</div><div class="dl-v">' + escHtml(maskName(rec.response || 'なし')) + '</div></div>' +
    (rec.notes && rec.notes !== 'nan' && rec.notes.trim() ?
      '<div class="dl"><div class="dl-l">特記事項</div><div class="dl-v">' + escHtml(maskName(rec.notes)) + '</div></div>' : '') +
    '<div style="margin-top:14px;display:flex;gap:8px">' +
    '<button class="btn btn-sm btn-p" onclick="openModal(' + idx + ')">詳細を見る</button>' +
    (rec.userId && rec.userId !== '---' ?
      '<button class="btn btn-sm btn-g" onclick="openKarteFromHome(\'' + escAttr(rec.userId) + '\')">カルテを見る</button>' : '') +
    '</div></div></div>';
}

function renderResults() {
  var srDiv = document.getElementById('sr');
  var riDiv = document.getElementById('ri');
  var seDiv = document.getElementById('se');
  var moreDiv = document.getElementById('smore');
  if (!STATE.results.length) {
    srDiv.innerHTML = '<div class="empty-state"><div class="empty-i">' + icon('search-x', 48) + '</div><p class="empty-t">該当するレコードがありません</p></div>';
    riDiv.style.display = 'none';
    seDiv.style.display = 'none';
    moreDiv.style.display = 'none';
    return;
  }
  seDiv.style.display = 'none';
  riDiv.style.display = 'flex';
  document.getElementById('rn').textContent = STATE.results.length;
  var repBanner = '';
  if (STATE.searchMode === 'uid' && STATE.results.length > 1) {
    var uid = STATE.results[0].userId;
    if (uid && uid !== '未確認') {
      repBanner = '<div class="rep-banner">' + icon('repeat', 16) + ' このユーザーは<b> ' + STATE.results.length + '回 </b>ご来店されています' +
        '（初回: ' + formatDate(STATE.results[STATE.results.length - 1].date) + '）' +
        ' <button class="btn btn-sm btn-p" style="margin-left:10px" onclick="openKarteFromHome(\'' + escAttr(uid) + '\')">カルテを見る</button>' +
        '</div>';
    }
  }
  var html = repBanner + '<div class="r2c">';
  var toShow = STATE.results.slice(0, STATE.displayCount);
  for (var i = 0; i < toShow.length; i++) {
    html += renderRecordCard(toShow[i], STATE.data.indexOf(toShow[i]));
  }
  html += '</div>';
  srDiv.innerHTML = html;
  moreDiv.style.display = STATE.results.length > STATE.displayCount ? 'block' : 'none';
}

function renderDeviceSummary(query) {
  var box = document.getElementById('devSummary');
  if (!STATE.results.length) { box.innerHTML = ''; return; }
  var byDevice = {};
  STATE.results.forEach(function(r) {
    var key = r.deviceSimple || '不明';
    if (!byDevice[key]) byDevice[key] = { count: 0 };
    byDevice[key].count++;
  });
  var html = '<div style="margin-top:12px;padding:12px;background:var(--bg);border-radius:8px;font-size:.85rem">';
  html += '<b>機種分布:</b> ';
  Object.keys(byDevice).sort(function(a, b) { return byDevice[b].count - byDevice[a].count; }).forEach(function(dev) {
    html += '<span class="tg tg-dv" style="margin:2px">' + escHtml(dev) + ' ' + byDevice[dev].count + '件</span> ';
  });
  html += '</div>';
  box.innerHTML = html;
}

function renderHome() {
  var hasData = STATE.data.length > 0;
  document.getElementById('nodata').style.display = hasData ? 'none' : 'block';
  document.getElementById('hasdata').style.display = hasData ? 'block' : 'none';
  if (!hasData) return;

  var now = new Date();
  var thisYM = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
  var thisMonthCount = 0;
  var catCounts = {};
  var uniqueIds = {};
  var escCount = 0;

  for (var i = 0; i < STATE.data.length; i++) {
    var r = STATE.data[i];
    if (r.date && r.date.substring(0, 7) === thisYM) thisMonthCount++;
    catCounts[r.category] = (catCounts[r.category] || 0) + 1;
    if (isValidUserId(r.userId)) uniqueIds[r.userId] = true;
    if (hasEscalation(r)) escCount++;
  }
  var uniqueUsers = Object.keys(uniqueIds).length;

  document.getElementById('stats').innerHTML =
    '<div class="st" onclick="go(\'search\')"><div class="st-v">' + STATE.data.length + '</div><div class="st-l">全レコード</div></div>' +
    '<div class="st" onclick="searchByPeriod(\'1\')"><div class="st-v">' + thisMonthCount + '</div><div class="st-l">今月の対応</div></div>' +
    '<div class="st"><div class="st-v">' + uniqueUsers + '</div><div class="st-l">ユニークユーザー</div></div>' +
    '<div class="st" onclick="searchByEscalation()"><div class="st-v">' + escCount + '</div><div class="st-l">エスカレ件数</div></div>';

  var topCats = Object.keys(catCounts)
    .filter(function(k) { return k !== 'その他・一般'; })
    .map(function(k) { return [k, catCounts[k]]; })
    .sort(function(a, b) { return b[1] - a[1]; })
    .slice(0, 8);

  document.getElementById('qgrid').innerHTML = topCats.map(function(e) {
    return '<button class="qbtn" onclick="searchByCategory(\'' + escAttr(e[0]) + '\')">' +
      escHtml(e[0]) + '<b>' + e[1] + '</b></button>';
  }).join('');

  var recentHtml = '';
  var recentItems = STATE.data.slice(0, 5);
  for (var ri = 0; ri < recentItems.length; ri++) {
    var rc = recentItems[ri];
    var ridx = ri;
    var resc = hasEscalation(rc);
    var rmedia = hasMediaCapture(rc);
    var rrepeat = getRepeatCount(rc.userId);
    recentHtml += '<div class="rec" onclick="openModal(' + ridx + ')">' +
      '<div class="rc-meta">' +
      '<span class="tg tg-dt">' + formatDate(rc.date) + '</span>' +
      '<span class="tg tg-ct">' + escHtml(rc.category) + '</span>' +
      '<span class="tg tg-id">' + escHtml(rc.userId || '') + '</span>' +
      (resc ? '<span class="tg tg-esc">' + icon('zap', 14) + 'エスカレ</span>' : '') +
      (rmedia ? '<span class="tg tg-media">' + icon('camera', 14) + '</span>' : '') +
      (rrepeat > 1 ? '<span class="tg tg-rep">' + icon('repeat', 14) + rrepeat + '回</span>' : '') +
      '</div>' +
      '<div style="font-size:.88rem;color:var(--text2);margin-top:4px;line-height:1.5">' + escHtml(maskName(truncate(rc.complaint, 60))) + '</div>' +
      '</div>';
  }
  document.getElementById('recent').innerHTML = recentHtml;

  // Weekly summary
  renderWeeklySummary();
}

function getWeekRange(weeksAgo) {
  var now = new Date();
  var dayOfWeek = now.getDay() || 7; // 月曜=1
  var monday = new Date(now);
  monday.setDate(now.getDate() - dayOfWeek + 1 - (weeksAgo * 7));
  monday.setHours(0, 0, 0, 0);
  var sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);
  return {
    start: monday.getFullYear() + '-' + String(monday.getMonth() + 1).padStart(2, '0') + '-' + String(monday.getDate()).padStart(2, '0'),
    end: sunday.getFullYear() + '-' + String(sunday.getMonth() + 1).padStart(2, '0') + '-' + String(sunday.getDate()).padStart(2, '0'),
    label: (monday.getMonth() + 1) + '/' + monday.getDate() + '〜' + (sunday.getMonth() + 1) + '/' + sunday.getDate()
  };
}

function renderWeeklySummary() {
  var container = document.getElementById('weeklySummary');
  var select = document.getElementById('weekSelect');
  if (!container || !select) return;

  // プルダウン構築（初回のみ）
  if (select.options.length === 0) {
    var labels = ['今週', '前回（先週）', '前々回（2週前）', '3週前', '4週前', '5週前', '6週前', '7週前'];
    for (var i = 0; i < labels.length; i++) {
      var wr = getWeekRange(i);
      var recs = STATE.data.filter(function(r) { return r.date >= wr.start && r.date <= wr.end; });
      var opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = labels[i] + '（' + wr.label + '）' + recs.length + '件';
      select.appendChild(opt);
    }
    select.value = '1'; // デフォルトは前回（先週）
  }

  var weeksAgo = parseInt(select.value) || 0;
  var range = getWeekRange(weeksAgo);
  var records = STATE.data.filter(function(r) {
    return r.date >= range.start && r.date <= range.end;
  });

  if (records.length === 0) {
    container.innerHTML = '<div class="wk-none">この週の対応記録はありません</div>';
    return;
  }

  // 統計集計
  var cats = {};
  var staffSet = {};
  var escCount = 0;
  records.forEach(function(r) {
    cats[r.category] = (cats[r.category] || 0) + 1;
    if (r.staff) r.staff.split(',').forEach(function(s) { if (s.trim()) staffSet[s.trim()] = true; });
    if (hasEscalation(r)) escCount++;
  });
  var topCats = Object.keys(cats).sort(function(a, b) { return cats[b] - cats[a]; }).slice(0, 3);

  // 統計サマリー（常に表示）
  var html = '<div class="wk-stat">';
  html += '<div class="wk-stat-item">対応 <span class="wk-stat-n">' + records.length + '件</span></div>';
  if (Object.keys(staffSet).length > 0) {
    html += '<div class="wk-stat-item">担当 <span class="wk-stat-n">' + Object.keys(staffSet).join(', ') + '</span></div>';
  }
  if (escCount > 0) {
    html += '<div class="wk-stat-item">' + icon('zap', 14) + ' エスカレ <span class="wk-stat-n">' + escCount + '件</span></div>';
  }
  if (topCats.length > 0) {
    html += '<div class="wk-stat-item">多い相談 <span class="wk-stat-n">' + topCats.map(function(c) { return escHtml(c) + '(' + cats[c] + ')'; }).join(' ') + '</span></div>';
  }
  html += '</div>';

  // レコード一覧（アコーディオンで開閉）
  html += '<div class="wk-details">';
  html += '<div class="wk-details-hd" onclick="this.parentElement.classList.toggle(\'open\');updateWkToggleLabel()">';
  html += '<span style="font-size:.85rem;font-weight:600;color:var(--navy-700)">対応一覧（' + records.length + '件）</span>';
  html += '<span class="wk-details-arrow">▶</span>';
  html += '</div>';
  html += '<div class="wk-details-body">';

  records.forEach(function(r, i) {
    var idx = STATE.data.indexOf(r);
    var esc = hasEscalation(r);
    var repeat = getRepeatCount(r.userId);
    html += '<div class="wk-acc">';
    html += '<div class="wk-acc-hd" onclick="toggleWkAcc(this)">';
    html += '<div style="flex:1">';
    html += '<span class="wk-rec-date">' + formatDate(r.date) + '</span>';
    html += '<span class="wk-rec-cat">' + escHtml(r.category) + '</span>';
    if (r.userId && isValidUserId(r.userId)) {
      html += '<span style="font-size:.78rem;color:var(--blue);font-family:monospace">' + escHtml(r.userId) + '</span>';
    }
    if (esc) html += ' <span style="font-size:.75rem;color:var(--red);font-weight:600">' + icon('zap', 14) + 'エスカレ</span>';
    if (repeat > 1) html += ' <span style="font-size:.75rem;color:var(--purple);font-weight:600">' + icon('repeat', 14) + repeat + '回</span>';
    html += '<div class="wk-rec-body">' + escHtml(maskName(truncate(r.complaint, 60))) + '</div>';
    html += '</div>';
    html += '<span class="wk-acc-arrow">▶</span>';
    html += '</div>';
    html += '<div class="wk-acc-body">';
    html += '<div class="wk-acc-sec"><div class="wk-acc-label">相談内容</div><div class="wk-acc-val">' + escHtml(maskName(r.complaint || '')) + '</div></div>';
    html += '<div class="wk-acc-sec"><div class="wk-acc-label">対応内容</div><div class="wk-acc-val">' + escHtml(maskName(r.response || '')) + '</div></div>';
    if (r.notes) html += '<div class="wk-acc-sec"><div class="wk-acc-label">特記事項</div><div class="wk-acc-val">' + escHtml(maskName(r.notes)) + '</div></div>';
    html += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;font-size:.8rem;color:var(--text3)">';
    if (r.device) html += '<span>機種: ' + escHtml(r.deviceSimple) + '</span>';
    if (r.staff) html += '<span>担当: ' + escHtml(r.staff) + '</span>';
    if (r.duration) html += '<span>時間: ' + escHtml(r.duration) + '</span>';
    html += '</div>';
    if (r.userId && isValidUserId(r.userId)) {
      html += '<button class="btn btn-sm" style="margin-top:10px;font-size:.8rem" onclick="go(\'karte\');setTimeout(function(){showKarte(\'' + escAttr(r.userId) + '\')},100)">カルテを見る</button>';
    }
    html += '</div></div>';
  });

  html += '</div></div>';

  container.innerHTML = html;
}

function toggleWkAcc(el) {
  var acc = el.parentElement;
  var wasOpen = acc.classList.contains('open');
  // 他のアコーディオンを閉じる
  var siblings = acc.parentElement.querySelectorAll('.wk-acc.open');
  for (var i = 0; i < siblings.length; i++) siblings[i].classList.remove('open');
  // 自分をトグル
  if (!wasOpen) acc.classList.add('open');
  updateWkToggleLabel();
}

function updateWkToggleLabel() {
  // placeholder for future use
}

// ===== STATS PANEL =====
var STATS_PERIOD = 'all';

function setStatsPeriod(period) {
  STATS_PERIOD = period;
  renderStatsPanel();
}

function getStatsDateRange(period) {
  var now = new Date();
  var y = now.getFullYear();
  var m = now.getMonth();
  if (period === 'thisMonth') return { start: y + '-' + String(m + 1).padStart(2, '0') + '-01', end: '9999-12-31', label: y + '年' + (m + 1) + '月' };
  if (period === 'lastMonth') {
    var lm = new Date(y, m - 1, 1);
    var lme = new Date(y, m, 0);
    return { start: lm.getFullYear() + '-' + String(lm.getMonth() + 1).padStart(2, '0') + '-01', end: lme.getFullYear() + '-' + String(lme.getMonth() + 1).padStart(2, '0') + '-' + String(lme.getDate()).padStart(2, '0'), label: lm.getFullYear() + '年' + (lm.getMonth() + 1) + '月' };
  }
  if (period === '3m') { var s = new Date(y, m - 2, 1); return { start: s.getFullYear() + '-' + String(s.getMonth() + 1).padStart(2, '0') + '-01', end: '9999-12-31', label: '過去3ヶ月' }; }
  if (period === '6m') { var s6 = new Date(y, m - 5, 1); return { start: s6.getFullYear() + '-' + String(s6.getMonth() + 1).padStart(2, '0') + '-01', end: '9999-12-31', label: '過去6ヶ月' }; }
  if (period === 'thisYear') return { start: y + '-01-01', end: '9999-12-31', label: y + '年' };
  if (period === 'custom') {
    var from = document.getElementById('stats-from');
    var to = document.getElementById('stats-to');
    var sv = from ? from.value : '';
    var ev = to ? to.value : '';
    return { start: sv || '0000-01-01', end: ev || '9999-12-31', label: (sv || '---') + ' 〜 ' + (ev || '---') };
  }
  return { start: '0000-01-01', end: '9999-12-31', label: '全期間' };
}

function filterByPeriod(records, range) {
  return records.filter(function(r) { return r.date >= range.start && r.date <= range.end; });
}

function renderStatsPanel() {
  var container = document.getElementById('statsContent');
  if (!container) return;
  if (!STATE.data.length) {
    container.innerHTML = '<div class="empty-state"><div class="empty-i">' + icon('bar-chart-3', 48) + '</div><p class="empty-t">データがありません</p></div>';
    return;
  }

  var range = getStatsDateRange(STATS_PERIOD);
  var data = filterByPeriod(STATE.data, range);
  var html = '';

  // Period selector - 5 buttons (reduced from 7: removed lastMonth and 6m)
  html += '<div class="stats-period">';
  var periods = [['thisMonth','今月'],['3m','3ヶ月'],['thisYear','今年'],['all','全期間'],['custom','期間指定']];
  periods.forEach(function(p) {
    html += '<button class="stats-period-btn' + (STATS_PERIOD === p[0] ? ' on' : '') + '" onclick="setStatsPeriod(\'' + p[0] + '\')">' + p[1] + '</button>';
  });
  html += '</div>';

  // Custom date inputs
  if (STATS_PERIOD === 'custom') {
    var fromVal = document.getElementById('stats-from') ? document.getElementById('stats-from').value : '';
    var toVal = document.getElementById('stats-to') ? document.getElementById('stats-to').value : '';
    html += '<div style="display:flex;gap:8px;align-items:center;margin-bottom:16px;flex-wrap:wrap">';
    html += '<label style="font-size:.85rem;color:var(--text2);font-weight:600">開始</label>';
    html += '<input type="date" class="sinput" id="stats-from" value="' + escAttr(fromVal) + '" style="flex:1;min-height:48px;font-size:1rem" onchange="renderStatsPanel()">';
    html += '<label style="font-size:.85rem;color:var(--text2);font-weight:600">〜</label>';
    html += '<input type="date" class="sinput" id="stats-to" value="' + escAttr(toVal) + '" style="flex:1;min-height:48px;font-size:1rem" onchange="renderStatsPanel()">';
    html += '</div>';
  }

  // Period label + count
  html += '<div class="stats-period-label">' + escHtml(range.label) + ' &mdash; <span class="stats-period-count">' + data.length + '件</span></div>';

  if (!data.length) {
    html += '<div class="empty-state"><div class="empty-i">' + icon('bar-chart-3', 48) + '</div><p class="empty-t">この期間のデータはありません</p></div>';
    container.innerHTML = html;
    return;
  }

  // === Compute all stats data upfront ===
  var uniqueIds = {};
  var periodUserCount = {};
  var escCount = 0;
  var totalMin = 0;
  var durCount = 0;
  var staffSet = {};
  var locationCounts = {};
  var monthEscCounts = {};
  var durBuckets = [0, 0, 0, 0]; // <15, 15-30, 30-60, 60+

  data.forEach(function(r) {
    if (isValidUserId(r.userId)) {
      uniqueIds[r.userId] = true;
      periodUserCount[r.userId] = (periodUserCount[r.userId] || 0) + 1;
    }
    if (hasEscalation(r)) {
      escCount++;
      if (r.date) {
        var escYm = r.date.substring(0, 7);
        monthEscCounts[escYm] = (monthEscCounts[escYm] || 0) + 1;
      }
    }
    if (r.duration) {
      var mm = parseDuration(r.duration);
      if (mm > 0) {
        totalMin += mm; durCount++;
        if (mm < 15) durBuckets[0]++;
        else if (mm < 30) durBuckets[1]++;
        else if (mm < 60) durBuckets[2]++;
        else durBuckets[3]++;
      }
    }
    if (r.staff) r.staff.split(',').forEach(function(s) { var t = s.trim(); if (t && t !== 'nan') staffSet[t] = true; });
    var loc = r.location ? r.location.trim() : '';
    if (loc && loc !== 'nan') locationCounts[loc] = (locationCounts[loc] || 0) + 1;
  });
  var avgMin = durCount > 0 ? Math.round(totalMin / durCount) : 0;

  // Repeater detection via global userIndex
  var repeatUsers = 0;
  var newUsers = 0;
  var allUniqueKeys = Object.keys(uniqueIds);
  for (var ui = 0; ui < allUniqueKeys.length; ui++) {
    var uid = allUniqueKeys[ui];
    var globalCount = STATE.userIndex ? (STATE.userIndex[uid] || 0) : 0;
    if (globalCount > 1 || periodUserCount[uid] > 1) {
      repeatUsers++;
    } else {
      newUsers++;
    }
  }

  // === KPI Cards (6 cards, 3x2 grid) ===
  html += '<div class="kpi-grid">';
  html += '<div class="kpi"><div class="kpi-v">' + data.length + '</div><div class="kpi-l">対応件数</div></div>';
  html += '<div class="kpi"><div class="kpi-v">' + allUniqueKeys.length + '</div><div class="kpi-l">ユニークユーザー</div></div>';
  html += '<div class="kpi"><div class="kpi-v">' + repeatUsers + '</div><div class="kpi-l">リピーター</div><div class="kpi-sub">複数回来所</div></div>';
  html += '<div class="kpi"><div class="kpi-v">' + escCount + '</div><div class="kpi-l">エスカレーション</div><div class="kpi-sub">' + (data.length > 0 ? (escCount / data.length * 100).toFixed(1) + '%' : '---') + '</div></div>';
  html += '<div class="kpi"><div class="kpi-v">' + (avgMin > 0 ? avgMin + '<span style="font-size:.9rem;font-weight:600">分</span>' : '---') + '</div><div class="kpi-l">平均対応時間</div></div>';
  html += '<div class="kpi"><div class="kpi-v">' + Object.keys(staffSet).length + '</div><div class="kpi-l">担当者数</div></div>';
  html += '</div>';

  // === New vs Repeat Users Ratio Bar ===
  var totalUnique = newUsers + repeatUsers;
  if (totalUnique > 0) {
    var newPct = Math.round(newUsers / totalUnique * 100);
    var repPct = 100 - newPct;
    html += '<div class="chart-card">';
    html += '<div class="chart-card-t"><span class="ct-ico">' + icon('user-plus', 20) + '</span>新規 vs リピーター</div>';
    html += '<div style="display:flex;gap:16px;margin-bottom:12px">';
    html += '<div style="flex:1;text-align:center"><div style="font-size:1.5rem;font-weight:800;color:var(--blue)">' + newUsers + '<span style="font-size:.85rem;font-weight:600">人</span></div><div style="font-size:.8rem;color:var(--text2);font-weight:500">初回来訪 (' + newPct + '%)</div></div>';
    html += '<div style="flex:1;text-align:center"><div style="font-size:1.5rem;font-weight:800;color:var(--amber)">' + repeatUsers + '<span style="font-size:.85rem;font-weight:600">人</span></div><div style="font-size:.8rem;color:var(--text2);font-weight:500">リピーター (' + repPct + '%)</div></div>';
    html += '</div>';
    html += '<div class="ratio-bar">';
    if (newPct > 0) html += '<div class="ratio-seg" style="width:' + newPct + '%;background:var(--blue)">' + (newPct >= 12 ? newPct + '%' : '') + '</div>';
    if (repPct > 0) html += '<div class="ratio-seg" style="width:' + repPct + '%;background:var(--amber)">' + (repPct >= 12 ? repPct + '%' : '') + '</div>';
    html += '</div>';
    html += '<div class="ratio-legend">';
    html += '<div class="ratio-legend-item"><div class="ratio-dot" style="background:var(--blue)"></div>初回</div>';
    html += '<div class="ratio-legend-item"><div class="ratio-dot" style="background:var(--amber)"></div>リピーター</div>';
    html += '</div>';
    html += '</div>';
  }

  // === Monthly Trend Bar Chart ===
  var monthCounts = {};
  data.forEach(function(r) {
    if (r.date) { var ym = r.date.substring(0, 7); monthCounts[ym] = (monthCounts[ym] || 0) + 1; }
  });
  var monthKeys = Object.keys(monthCounts).sort();

  if (monthKeys.length > 1) {
    var maxMonth = Math.max.apply(null, monthKeys.map(function(k) { return monthCounts[k]; }));
    // Detect if data spans multiple years
    var yearSet = {};
    monthKeys.forEach(function(ym) { yearSet[ym.split('-')[0]] = true; });
    var multiYear = Object.keys(yearSet).length > 1;

    html += '<div class="chart-card">';
    html += '<div class="chart-card-t"><span class="ct-ico">' + icon('trending-up', 20) + '</span>月別対応件数</div>';
    html += '<div class="vbar-wrap">';
    monthKeys.forEach(function(ym) {
      var count = monthCounts[ym];
      var pct = maxMonth > 0 ? (count / maxMonth * 100) : 0;
      html += '<div class="vbar"><div class="vbar-val">' + count + '</div><div class="vbar-fill" style="height:' + Math.max(pct, 15) + '%"></div></div>';
    });
    html += '</div>';
    html += '<div class="vbar-labels">';
    var prevYear = '';
    monthKeys.forEach(function(ym) {
      var parts = ym.split('-');
      var yr = parts[0];
      var mon = parseInt(parts[1]);
      var showYear = multiYear && (yr !== prevYear);
      prevYear = yr;
      html += '<div class="vbar-lbl">' + mon + '月' + (showYear ? '<span class="vbar-lbl-year">' + yr + '</span>' : '') + '</div>';
    });
    html += '</div></div>';
  }

  // === Escalation Count (vertical bar chart) ===
  if (monthKeys.length > 1) {
    var escCounts = monthKeys.map(function(ym) {
      return monthEscCounts[ym] || 0;
    });
    var maxEsc = Math.max.apply(null, escCounts);
    if (maxEsc === 0) maxEsc = 1;

    html += '<div class="chart-card">';
    html += '<div class="chart-card-t"><span class="ct-ico">' + icon('zap', 20) + '</span>月別エスカレーション件数</div>';
    html += '<div class="vbar-wrap">';
    escCounts.forEach(function(val) {
      var pct = maxEsc > 0 ? (val / maxEsc * 100) : 0;
      var h = val > 0 ? Math.max(pct, 15) : 3;
      html += '<div class="vbar"><div class="vbar-val">' + val + '</div><div class="vbar-fill" style="height:' + h + '%;background:var(--red)"></div></div>';
    });
    html += '</div>';
    html += '<div class="vbar-labels">';
    var spkPrevYr = '';
    monthKeys.forEach(function(ym) {
      var parts = ym.split('-');
      var yr = parts[0];
      var mon = parseInt(parts[1]);
      var showYr = multiYear && (yr !== spkPrevYr);
      spkPrevYr = yr;
      html += '<div class="vbar-lbl">' + mon + '月' + (showYr ? '<span class="vbar-lbl-year">' + yr + '</span>' : '') + '</div>';
    });
    html += '</div></div>';
  }

  // === Category Horizontal Bar ===
  var catCounts = {};
  data.forEach(function(r) { catCounts[r.category] = (catCounts[r.category] || 0) + 1; });
  var catEntries = Object.keys(catCounts).map(function(k) { return [k, catCounts[k]]; }).sort(function(a, b) { return b[1] - a[1]; });
  var maxCat = catEntries.length > 0 ? catEntries[0][1] : 1;
  var colors = ['var(--blue)', 'var(--green)', 'var(--amber)', 'var(--purple)', 'var(--red)', 'var(--navy-500)', '#0891b2', '#be185d', '#4338ca', '#b45309'];

  html += '<div class="chart-card">';
  html += '<div class="chart-card-t"><span class="ct-ico">' + icon('clipboard-list', 20) + '</span>相談カテゴリ別（' + catEntries.length + '種類）</div>';
  catEntries.slice(0, 12).forEach(function(e, i) {
    var pct = (e[1] / maxCat * 100);
    var pctLabel = data.length > 0 ? ' (' + Math.round(e[1] / data.length * 100) + '%)' : '';
    html += '<div class="hbar hbar-clickable" onclick="searchByCategory(\'' + escAttr(e[0]) + '\')">';
    html += '<div class="hbar-label" title="' + escAttr(e[0]) + '">' + escHtml(e[0]) + '</div>';
    html += '<div class="hbar-track"><div class="hbar-fill" style="width:' + pct + '%;background:' + colors[i % colors.length] + '"></div></div>';
    html += '<div class="hbar-num">' + e[1] + '件' + pctLabel + '</div>';
    html += '</div>';
  });
  if (catEntries.length > 12) {
    var others = catEntries.slice(12).reduce(function(s, e) { return s + e[1]; }, 0);
    html += '<div style="font-size:.82rem;color:var(--text3);padding:8px 0">他 ' + (catEntries.length - 12) + 'カテゴリ: ' + others + '件</div>';
  }
  html += '</div>';

  // === Location Breakdown ===
  var locEntries = Object.keys(locationCounts).map(function(k) { return [k, locationCounts[k]]; }).sort(function(a, b) { return b[1] - a[1]; });
  if (locEntries.length > 0) {
    var maxLoc = locEntries[0][1];
    html += '<div class="chart-card">';
    html += '<div class="chart-card-t"><span class="ct-ico">' + icon('map-pin', 20) + '</span>場所別対応件数</div>';
    locEntries.forEach(function(e, i) {
      var pct = (e[1] / maxLoc * 100);
      var locPctLabel = data.length > 0 ? ' (' + Math.round(e[1] / data.length * 100) + '%)' : '';
      html += '<div class="hbar">';
      html += '<div class="hbar-label">' + escHtml(e[0]) + '</div>';
      html += '<div class="hbar-track"><div class="hbar-fill" style="width:' + pct + '%;background:' + colors[i % colors.length] + '"></div></div>';
      html += '<div class="hbar-num">' + e[1] + '件' + locPctLabel + '</div>';
      html += '</div>';
    });
    html += '</div>';
  }

  // === Duration Distribution ===
  if (durCount > 0) {
    var durLabels = ['15分未満', '15〜30分', '30〜60分', '60分以上'];
    var durColors = ['var(--green)', 'var(--blue)', 'var(--amber)', 'var(--red)'];
    var maxDur = Math.max.apply(null, durBuckets);
    html += '<div class="chart-card">';
    html += '<div class="chart-card-t"><span class="ct-ico">' + icon('timer', 20) + '</span>対応時間の分布（' + durCount + '件）</div>';
    for (var bi = 0; bi < 4; bi++) {
      var dpct = maxDur > 0 ? (durBuckets[bi] / maxDur * 100) : 0;
      var dratio = durCount > 0 ? ' (' + Math.round(durBuckets[bi] / durCount * 100) + '%)' : '';
      html += '<div class="hbar">';
      html += '<div class="hbar-label">' + durLabels[bi] + '</div>';
      html += '<div class="hbar-track"><div class="hbar-fill" style="width:' + dpct + '%;background:' + durColors[bi] + '"></div></div>';
      html += '<div class="hbar-num">' + durBuckets[bi] + '件' + dratio + '</div>';
      html += '</div>';
    }
    html += '</div>';
  }

  // === Device Horizontal Bar ===
  var devCounts = {};
  data.forEach(function(r) { var d = r.deviceSimple || '不明'; devCounts[d] = (devCounts[d] || 0) + 1; });
  var devEntries = Object.keys(devCounts).map(function(k) { return [k, devCounts[k]]; }).sort(function(a, b) { return b[1] - a[1]; });
  var maxDev = devEntries.length > 0 ? devEntries[0][1] : 1;

  html += '<div class="chart-card">';
  html += '<div class="chart-card-t"><span class="ct-ico">' + icon('smartphone', 20) + '</span>デバイス別</div>';
  devEntries.slice(0, 10).forEach(function(e, i) {
    var pct = (e[1] / maxDev * 100);
    html += '<div class="hbar">';
    html += '<div class="hbar-label">' + escHtml(e[0]) + '</div>';
    html += '<div class="hbar-track"><div class="hbar-fill" style="width:' + pct + '%;background:' + colors[i % colors.length] + '"></div></div>';
    html += '<div class="hbar-num">' + e[1] + '件</div>';
    html += '</div>';
  });
  html += '</div>';

  // === Staff Horizontal Bar ===
  var staffCounts = {};
  data.forEach(function(r) {
    if (r.staff) r.staff.split(',').forEach(function(s) {
      var t = s.trim();
      if (t && t !== 'nan') staffCounts[t] = (staffCounts[t] || 0) + 1;
    });
  });
  var staffEntries = Object.keys(staffCounts).map(function(k) { return [k, staffCounts[k]]; }).sort(function(a, b) { return b[1] - a[1]; });
  var maxStaff = staffEntries.length > 0 ? staffEntries[0][1] : 1;

  if (staffEntries.length > 0) {
    html += '<div class="chart-card">';
    html += '<div class="chart-card-t"><span class="ct-ico">' + icon('users', 20) + '</span>担当者別対応件数</div>';
    staffEntries.forEach(function(e, i) {
      var pct = (e[1] / maxStaff * 100);
      html += '<div class="hbar">';
      html += '<div class="hbar-label">' + escHtml(e[0]) + '</div>';
      html += '<div class="hbar-track"><div class="hbar-fill" style="width:' + pct + '%;background:' + colors[i % colors.length] + '"></div></div>';
      html += '<div class="hbar-num">' + e[1] + '件</div>';
      html += '</div>';
    });
    html += '</div>';
  }

  // === Day of Week + Time Heatmap ===
  var dayNames = ['月','火','水','木','金','土','日'];
  var timeSlots = ['9-11時','11-13時','13-15時','15-17時','17時〜'];
  var heatData = {};
  for (var hdi = 0; hdi < 7; hdi++) {
    for (var hti = 0; hti < 5; hti++) {
      heatData[hdi + '-' + hti] = 0;
    }
  }

  data.forEach(function(r) {
    if (!r.date || !r.startTime) return;
    var parts = r.date.split('-');
    if (parts.length !== 3) return;
    var dt = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    var dow = dt.getDay();
    dow = dow === 0 ? 6 : dow - 1; // 月=0, 日=6
    var hourMatch = r.startTime.match(/(\d+):/);
    if (!hourMatch) return;
    var hour = parseInt(hourMatch[1]);
    var slot;
    if (hour < 11) slot = 0;
    else if (hour < 13) slot = 1;
    else if (hour < 15) slot = 2;
    else if (hour < 17) slot = 3;
    else slot = 4;
    heatData[dow + '-' + slot]++;
  });

  var heatVals = [];
  for (var hk in heatData) { if (heatData.hasOwnProperty(hk)) heatVals.push(heatData[hk]); }
  var hmMax = heatVals.length > 0 ? Math.max.apply(null, heatVals) : 0;

  html += '<div class="chart-card">';
  html += '<div class="chart-card-t"><span class="ct-ico">' + icon('calendar-days', 20) + '</span>曜日 × 時間帯</div>';
  html += '<div class="heatmap">';
  // Header row
  html += '<div></div>';
  dayNames.forEach(function(d) { html += '<div class="hm-header">' + d + '</div>'; });
  // Data rows
  timeSlots.forEach(function(ts, ti) {
    html += '<div class="hm-label">' + ts + '</div>';
    for (var hdi2 = 0; hdi2 < 7; hdi2++) {
      var val = heatData[hdi2 + '-' + ti];
      var intensity = hmMax > 0 ? val / hmMax : 0;
      var bg, clr;
      if (val === 0) { bg = 'var(--bg2)'; clr = 'var(--text3)'; }
      else if (intensity < 0.25) { bg = '#dbeafe'; clr = '#1e40af'; }
      else if (intensity < 0.5) { bg = '#93c5fd'; clr = '#1e3a5f'; }
      else if (intensity < 0.75) { bg = '#3b82f6'; clr = '#fff'; }
      else { bg = '#1d4ed8'; clr = '#fff'; }
      html += '<div class="hm-cell" style="background:' + bg + ';color:' + clr + '">' + (val > 0 ? val : '-') + '</div>';
    }
  });
  html += '</div>';
  // Heatmap legend
  html += '<div style="display:flex;align-items:center;gap:6px;margin-top:10px;font-size:.72rem;color:var(--text3)">';
  html += '<span>少</span>';
  html += '<div style="width:16px;height:16px;border-radius:3px;background:var(--bg2)"></div>';
  html += '<div style="width:16px;height:16px;border-radius:3px;background:#dbeafe"></div>';
  html += '<div style="width:16px;height:16px;border-radius:3px;background:#93c5fd"></div>';
  html += '<div style="width:16px;height:16px;border-radius:3px;background:#3b82f6"></div>';
  html += '<div style="width:16px;height:16px;border-radius:3px;background:#1d4ed8"></div>';
  html += '<span>多</span>';
  html += '</div>';
  html += '</div>';

  container.innerHTML = html;
}

function renderSettings() {
  document.getElementById('im').textContent = '現在: ' + STATE.data.length + '件のレコード';
  var raw = localStorage.getItem(CONFIG.storageKey) || '';
  var used = new Blob([raw]).size;
  var max = CONFIG.storageLimitBytes;
  var pct = ((used / max) * 100).toFixed(1);
  document.getElementById('sto').textContent =
    '使用量: ' + (used / 1024).toFixed(0) + 'KB / ' + (max / 1024).toFixed(0) + 'KB (' + pct + '%)';
  document.getElementById('sbf').style.width = Math.min(parseFloat(pct), 100) + '%';
  // 同期情報
  var lastSync = localStorage.getItem(CONFIG.syncKey);
  var syncInfo = document.getElementById('syncInfo');
  if (syncInfo) {
    syncInfo.textContent = lastSync ? '最終同期: ' + formatSyncTime(lastSync) : '未同期（サーバーからデータ未取得）';
  }
}

// ===== UI NAVIGATION =====
function go(tab) {
  document.querySelectorAll('.pnl').forEach(function(p) { p.classList.remove('on'); });
  var tabs = document.querySelectorAll('.tab');
  for (var i = 0; i < tabs.length; i++) {
    tabs[i].classList.remove('on');
    tabs[i].setAttribute('aria-selected', 'false');
  }
  document.getElementById('p-' + tab).classList.add('on');
  var tabIndex = { home: 0, karte: 1, search: 2, stats: 3, settings: 4 };
  if (tabIndex[tab] !== undefined) {
    tabs[tabIndex[tab]].classList.add('on');
    tabs[tabIndex[tab]].setAttribute('aria-selected', 'true');
  }
  if (tab === 'home') renderHome();
  if (tab === 'karte') {
    if (!STATE.currentKarteId) {
      renderKarteInit();
      setTimeout(function() { var el = document.getElementById('karteId'); if (el) el.focus(); }, 100);
    }
  }
  if (tab === 'stats') renderStatsPanel();
  if (tab === 'settings') renderSettings();
  window.scrollTo(0, 0);
}

function toggleCard(idx) {
  var el = document.getElementById('r' + idx);
  if (el) el.classList.toggle('exp');
}

function openModal(idx) {
  var rec = STATE.data[idx];
  if (!rec) return;
  var repeat = getRepeatCount(rec.userId);
  var esc = hasEscalation(rec);
  var media = hasMediaCapture(rec);
  document.getElementById('moTitle').textContent = '対応詳細';
  var html = '';
  if (repeat > 1) {
    html += '<div class="rep-banner" style="margin-bottom:18px">' + icon('repeat', 16) + ' このユーザーは<b> ' + repeat + '回目 </b>のご来店です</div>';
  }
  html += '<div class="mo-sec"><div class="mo-sec-t">基本情報</div>';
  var basicFields = [
    ['日付', formatDateWithRelative(rec.date)],
    ['時間', (rec.startTime || '') + ' - ' + (rec.endTime || '') + (rec.duration ? ' (' + rec.duration + ')' : '')],
    ['ユーザーID', rec.userId || '不明'],
    ['機種', rec.device || '不明'],
    ['機種（分類）', rec.deviceSimple || '不明'],
    ['性別', (rec.gender && rec.gender !== 'nan') ? rec.gender : ''],
    ['カテゴリ', rec.category || '']
  ];
  basicFields.forEach(function(f) {
    if (f[1]) html += '<div class="mo-f"><div class="mo-fl">' + f[0] + '</div><div class="mo-fv">' + escHtml(f[1]) + '</div></div>';
  });
  html += '</div>';
  html += '<div class="mo-sec"><div class="mo-sec-t">対応状況</div>';
  var statusFields = [
    ['担当', rec.staff || '記録なし'],
    ['場所', rec.location || ''],
    ['エスカレーション', esc ? icon('zap', 14) + ' あり（遠山）' : 'なし'],
    ['撮影記録', media ? icon('camera', 14) + ' あり' : 'なし']
  ];
  statusFields.forEach(function(f) {
    if (f[1]) html += '<div class="mo-f"><div class="mo-fl">' + f[0] + '</div><div class="mo-fv">' + escHtml(f[1]) + '</div></div>';
  });
  html += '</div>';
  html += '<div class="mo-sec"><div class="mo-sec-t">相談・対応内容</div>';
  html += '<div class="mo-f"><div class="mo-fl">相談内容</div><div class="mo-fv">' + escHtml(maskName(rec.complaint || 'なし')) + '</div></div>';
  html += '<div class="mo-f"><div class="mo-fl">対応内容</div><div class="mo-fv">' + escHtml(maskName(rec.response || 'なし')) + '</div></div>';
  if (rec.notes && rec.notes !== 'nan' && rec.notes.trim()) {
    html += '<div class="mo-f"><div class="mo-fl">特記事項</div><div class="mo-fv">' + escHtml(maskName(rec.notes)) + '</div></div>';
  }
  html += '</div>';
  // 類似事例サジェスト
  html += renderSimilarCases(rec);
  if (rec.userId && isValidUserId(rec.userId)) {
    html += '<div style="margin-top:16px;text-align:center"><button class="btn btn-p" onclick="closeModal();openKarteFromHome(\'' + escAttr(rec.userId) + '\')">このユーザーのカルテを見る</button></div>';
  }
  document.getElementById('mob').innerHTML = html;
  document.getElementById('mo').classList.add('on');
  document.addEventListener('keydown', trapModalFocus);
  var closeBtn = document.querySelector('.mo-x');
  if (closeBtn) closeBtn.focus();
}

function closeModal() {
  document.getElementById('mo').classList.remove('on');
  document.removeEventListener('keydown', trapModalFocus);
}

function trapModalFocus(e) {
  if (e.key === 'Escape') { closeModal(); return; }
  if (e.key !== 'Tab') return;
  var modal = document.querySelector('.mo-c');
  if (!modal) return;
  var focusable = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
  if (!focusable.length) return;
  var first = focusable[0];
  var last = focusable[focusable.length - 1];
  if (e.shiftKey) {
    if (document.activeElement === first) { e.preventDefault(); last.focus(); }
  } else {
    if (document.activeElement === last) { e.preventDefault(); first.focus(); }
  }
}

// ===== POPULATE FILTERS =====
function populateFilters() {
  var cats = [];
  var catSet = {};
  STATE.data.forEach(function(r) {
    if (!catSet[r.category]) { catSet[r.category] = true; cats.push(r.category); }
  });
  cats.sort();
  document.getElementById('fc').innerHTML =
    '<option value="">カテゴリ：全て</option>' +
    cats.map(function(c) { return '<option value="' + escHtml(c) + '">' + escHtml(c) + '</option>'; }).join('');

  var staffSet = {};
  STATE.data.forEach(function(r) {
    if (r.staff) {
      r.staff.split(',').forEach(function(s) {
        var trimmed = s.trim();
        if (trimmed && trimmed !== 'nan') staffSet[trimmed] = true;
      });
    }
  });
  var staffList = Object.keys(staffSet).sort();
  document.getElementById('fs').innerHTML =
    '<option value="">担当：全て</option>' +
    staffList.map(function(s) { return '<option value="' + escHtml(s) + '">' + escHtml(s) + '</option>'; }).join('');
}

// ===== UTILITY =====
function formatDate(d) {
  if (!d) return '';
  try {
    var parts = d.split('-');
    if (parts.length !== 3) return d;
    return parts[0] + '/' + parts[1] + '/' + parts[2];
  } catch (e) { return d; }
}

function relativeDate(d) {
  if (!d) return '';
  var parts = d.split('-');
  if (parts.length !== 3) return '';
  var then = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  var now = new Date();
  now.setHours(0, 0, 0, 0);
  var diffDays = Math.floor((now - then) / 86400000);
  if (diffDays < 0) return '';
  if (diffDays === 0) return '今日';
  if (diffDays === 1) return '昨日';
  if (diffDays < 7) return diffDays + '日前';
  if (diffDays < 30) return Math.floor(diffDays / 7) + '週間前';
  if (diffDays < 365) return Math.floor(diffDays / 30) + 'ヶ月前';
  return Math.floor(diffDays / 365) + '年前';
}

function formatDateWithRelative(d) {
  var abs = formatDate(d);
  var rel = relativeDate(d);
  if (!rel || rel === '今日') return abs;
  return abs + '（' + rel + '）';
}

function truncate(s, n) {
  if (!s || s === 'nan') return '';
  s = s.replace(/\n/g, ' ').trim();
  return s.length > n ? s.slice(0, n) + '…' : s;
}

function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function escAttr(s) {
  if (!s) return '';
  return String(s).replace(/&/g, '&amp;').replace(/'/g, '&#39;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function dismissPwaBanner() {
  var b = document.getElementById('pwaBanner');
  if (b) b.style.display = 'none';
  localStorage.setItem('pwa_banner_dismissed', '1');
}

function toast(message, type) {
  var el = document.getElementById('tt');
  el.textContent = message;
  el.className = 'toast v ' + (type || 'i');
  clearTimeout(el._timer);
  el._timer = setTimeout(function() { el.className = 'toast'; }, CONFIG.toastDuration);
}

function refreshAll() {
  document.getElementById('hCount').textContent = STATE.data.length + '件';
  buildUserIndex();
  populateFilters();
  // アクティブなタブだけ再描画
  var activeTab = document.querySelector('.tab.on');
  if (activeTab) {
    var target = activeTab.getAttribute('aria-controls');
    if (target === 'p-home') renderHome();
    if (target === 'p-stats') renderStatsPanel();
    if (target === 'p-settings') renderSettings();
  } else {
    renderHome();
  }
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', function() {
  initIcons();
  if (sessionStorage.getItem(CONFIG.sessionKey) === '1') showApp();

  // Enter key handlers
  ['qi', 'si-uid', 'si-dev', 'si-kw'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) {
      el.addEventListener('keydown', function(ev) {
        if (ev.key === 'Enter') {
          ev.preventDefault();
          if (id === 'qi') quickSearch();
          else doSearch();
        }
      });
    }
  });

  // Date range toggle
  var fpEl = document.getElementById('fp');
  if (fpEl) {
    fpEl.addEventListener('change', function() {
      var dr = document.getElementById('dateRange');
      if (dr) dr.style.display = this.value === 'custom' ? 'flex' : 'none';
    });
  }

  // Karte ID enter key
  var karteIdEl = document.getElementById('karteId');
  if (karteIdEl) {
    karteIdEl.addEventListener('keydown', function(ev) {
      if (ev.key === 'Enter') {
        ev.preventDefault();
        var v = karteIdEl.value.trim();
        if (v) showKarte(v);
      }
    });
  }

  // Modal backdrop close
  document.getElementById('mo').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
  });

  // PWA install banner
  if (!window.navigator.standalone && /iPad|iPhone/.test(navigator.userAgent)) {
    if (!localStorage.getItem('pwa_banner_dismissed')) {
      var b = document.getElementById('pwaBanner');
      if (b) b.style.display = 'flex';
    }
  }

});
</script>
</body>
</html>
